@page "{handler?}"
@using FOKE.Localization
@model FOKE.Pages.Unit.MemberSearchFormModel

@inject ISharedLocalizer Localize

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    var tokens = Antiforgery.GetAndStoreTokens(HttpContext);
}

<!-- Antiforgery Token -->
<input type="hidden" id="RequestVerificationToken" name="__RequestVerificationToken" value="@tokens.RequestToken" />

<style>
    .search-container {
        display: flex;
        justify-content: center;
        align-items: flex-start; /* align towards top */
        padding-top: 80px; /* push it down slightly */
        height: calc(100vh - 80px); /* keeps original height logic */
        background-color: #f9fbfd;
    }

    .search-card {
        background: white;
        padding: 2rem 3rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 700px;
        text-align: center;
    }

    .search-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: #2d3748;
    }

    .form-inline {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

        .form-inline select,
        .form-inline input {
            flex: 1;
            min-width: 150px;
        }

        .form-inline button {
            white-space: nowrap;
        }
</style>

<div class="search-container">
    <div class="search-card">
        <div class="search-title">@Localize.Localize("Search Users")</div>
        <div class="form-inline">
            <select asp-for="inputModel.SearchText" class="form-select form-select-sm"
                    asp-items='@new SelectList(Model.pageListFilterColumns, "ColumName", "ColumnDescription")'>
            </select>

            <input type="text" class="form-control form-control-sm" placeholder="Enter search keyword" id="txtSearchInputField" />

            <button type="button" class="btn btn-sm btn-primary" id="btnRefresh">
                <i class="fas fa-search"></i> Search
            </button>
        </div>

        <div id="resultsContainer" class="mt-5">
            <!-- Results will be populated here -->
        </div>

        <div class="mt-3 text-end">
            <button type="button" id="btnAssignSelected" class="btn btn-success w-25" style="display:none; ">
                <i class="fas fa-plus-circle"></i> Assign Users
            </button>
        </div>

    </div>

   

</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        // Helper function to disable checkboxes of already assigned members
        async function disableAlreadyAssignedMembers(unitId) {
            if (!unitId) return;

            try {
                const response = await fetch(`/Unit/MemberSearchForm?handler=AssignedMemberIds&unitId=${unitId}`);
                if (!response.ok) throw new Error("Failed to fetch assigned users");

                const assignedMemberIds = await response.json();

                document.querySelectorAll('.member-checkbox').forEach(chk => {
                    const memberId = parseInt(chk.value);
                    if (assignedMemberIds.includes(memberId)) {
                        chk.disabled = true;
                        chk.checked = false;
                        const row = chk.closest('tr');
                        if (row) row.style.backgroundColor = '#f8d7da'; // light red background for assigned
                    }
                });
            } catch (error) {
                console.error("Error fetching assigned member IDs:", error);
            }
        }

        // Search button click
        document.getElementById('btnRefresh').addEventListener('click', function () {
            const keyword = document.getElementById('txtSearchInputField').value.trim();
            const selectedColumn = document.querySelector('[name="inputModel.SearchText"]').value;

            if (keyword === "") {
                alert("Please enter a keyword to search.");
                return;
            }

            $.ajax({
                url: '@Url.Page("MemberSearchForm", "GetDetails")',
                type: 'GET',
                data: {
                    keyword: keyword,
                    searchText: selectedColumn
                },
                success: function (response) {
                    const container = document.getElementById('resultsContainer');
                    const assignBtn = document.getElementById('btnAssignSelected');

                    if (response && response.returnData && response.returnData.length > 0) {
                        const members = response.returnData;

                        let table = `
                            <table class="table table-bordered table-striped mt-3">
                                <thead class="table-light">
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" /></th>
                                        <th>User Name</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        members.forEach(member => {
                            table += `
                                <tr>
                                    <td><input type="checkbox" class="member-checkbox" value="${member.userId}" /></td>
                                 
                                    <td>${member.username || ''}</td>
                                 
                                </tr>
                            `;
                        });

                        table += `</tbody></table>`;
                        container.innerHTML = table;
                        assignBtn.style.display = 'inline-block';

                        // Disable checkboxes for already assigned members
                        const unitId = parseInt(new URLSearchParams(window.location.search).get("unitId"));
                       
                        disableAlreadyAssignedMembers(unitId);

                        // Select All checkbox logic
                        document.getElementById('selectAll').addEventListener('change', function () {
                            const checkboxes = document.querySelectorAll('.member-checkbox:not(:disabled)');
                            checkboxes.forEach(chk => chk.checked = this.checked);
                        });

                    } else {
                        container.innerHTML = `<p class="text-danger mt-3">No results found.</p>`;
                        assignBtn.style.display = 'none';
                    }
                },
                error: function () {
                    alert("An error occurred while fetching the user data.");
                }
            });
        });

        // Assign Selected Members button click
        document.getElementById('btnAssignSelected').addEventListener('click', function () {
            const selected = Array.from(document.querySelectorAll('.member-checkbox:checked'))
                .map(cb => parseInt(cb.value)); // Parse to number

            if (selected.length === 0) {
                alert("Please select at least one user.");
                return;
            }

            const unitId = parseInt(new URLSearchParams(window.location.search).get("unitId"));

            if (isNaN(unitId)) {
                alert("Unit ID is missing or invalid.");
                return;
            }
            console.log("Submitting selected memberIds: ", selected);

            $.ajax({
                url: '/Unit/MemberSearchForm?handler=AddMembersToUnit',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                   UnitId: unitId,
                    MemberIds: selected
                }),
                headers: {
                    'XSRF-TOKEN': $('#RequestVerificationToken').val()
                },
                success: function (res) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Users Assigned Successfully',
                        showConfirmButton: false,
                        timer: 2000
                    }).then(() => {

                        const selectedIds = new Set(selected);

                        document.querySelectorAll('.member-checkbox').forEach(chk => {
                            const row = chk.closest('tr');
                            const memberId = parseInt(chk.value);

                            if (selectedIds.has(memberId)) {
                                // Add red background for assigned rows
                                row.style.backgroundColor = '#f8d7da';  // light red color
                                // Disable checkbox so user can't assign again
                                chk.disabled = true;
                                chk.checked = false;
                            }
                        });

                        // Uncheck all remaining checkboxes and "Select All"
                        document.querySelectorAll('.member-checkbox:not(:disabled)').forEach(chk => chk.checked = false);
                        const selectAllCheckbox = document.getElementById('selectAll');
                        if (selectAllCheckbox) selectAllCheckbox.checked = false;

                        // Close popup and reload parent page
                        if (top && typeof top.hidePopupWithRefresh === 'function') {
                            top.hidePopupWithRefresh('btnRefresh');
                        } else {
                            console.warn("top.hidePopupWithRefresh function not found.");
                        }

                    });
                },
                error: function () {
                    alert("Error assigning users to the area.");
                }
            });
        });

    });
</script>






