@page
@model FOKE.Pages.Library.ManageModel
@{
}
@using FOKE.Localization
@inject ISharedLocalizer Localize
<input type="hidden" id="hidSearch" value="@Url.Page("~/Library/Manage")" />
<input type="hidden" id="Folderid" asp-for="Folderid" />
<input type="hidden" id="FolderName" asp-for="FolderName" />
<input type="hidden" id="hidPageCode" value="@Model.pagecode" />
<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
	<!--begin::Content wrapper-->
	<div class="d-flex flex-column flex-column-fluid">
		<!--begin::Toolbar-->
		<div id="kt_app_content" class="app-content flex-column-fluid">
			<!--begin::Content container-->
			<div id="kt_app_content_container" class="app-container container-xxl">
				<!--begin::Card-->
				<!--end::Card-->
				<!--begin::Card-->
				<div class="card card-flush">
					<!--begin::Card header-->
					<div class="card-header pt-5">
						<div class="card-title">
							<div class="row">
								<h3 class="fw-bold m-0 mb-5">
									@Model.FolderName
								</h3>


							</div>
						</div>
						<div class="d-flex align-items-center position-relative gap-2 my-1 pe-md-2 w-100 w-md-400px">
							<input type="text" asp-for="SearchText" class="form-control form-control-sm flex-grow-1" placeholder="Search" id="txtSearchInputField" />

							<button type="button" class="btn btn-sm btn-light-primary d-flex align-items-center gap-1 btnSearch" id="btnRefresh">
								<i class="fas fa-search"></i>
								@Localize.Localize("BTN_SEARCH")
							</button>

							<button type="button" class="btn btn-sm btn-light-primary d-flex align-items-center gap-1 btnReset" id="btnReset">
								<i class="fas fa-sync-alt"></i>
								@Localize.Localize("BTN_RESET")
							</button>
						</div>
					</div>
					<!--end::Card header-->
					<!--begin::Card body-->
					<div class="card-body">
						<!--begin::Table header-->
						<div class="d-flex justify-content-end">
							<!--begin::Folder path-->
							<!--end::Folder path-->
							<!--begin::Folder Stats-->
							@* <div class="badge badge-lg badge-primary">
								<span id="kt_file_manager_items_counter">82 items</span>
							</div> *@
							<!--end::Folder Stats-->
						</div>
						<!--end::Table header-->
						<!--begin::Table-->
						<div class="table-responsive">
							<table id="kt_file_manager_list" data-kt-filemanager-table="folders" class="table align-middle table-row-dashed fs-6 gy-5">
								<thead>
									<tr class="text-start text-gray-400 fw-bold fs-7 text-uppercase gs-0">
										<th class="min-w-150px min-w-sm-250px">Name</th>
										
										<th class="min-w-150px min-w-sm-250px">Date Modified</th>
										<th class="min-w-150px min-w-sm-250px">Type</th>
										<th class="min-w-150px min-w-sm-250px">Size</th>
										<th class="w-125px"></th>
									</tr>
								</thead>
								<tbody class="fw-semibold text-gray-600">
									@if (Model.pagedListData != null && Model.pagedListData.Count() > 0)
									{
										@for (int i = 0; i < Model.pagedListData.Count(); i++)
										{
											var item = Model.pagedListData[i];
											

											<tr>
											<td data-order="@item.FileName">
												<div class="d-flex align-items-center">
													<span class="icon-wrapper">
															
														@if (item.FileExtension != null)
														{
															
															string fileIconClass = item.FileExtension.ToLower() switch
															{
																".pdf" => "fa-solid fa-file-pdf text-danger",      // PDF icon in red
																".doc" or ".docx" => "fa-solid fa-file-word text-primary", // Word icon in blue
																".xls" or ".xlsx" => "fa-solid fa-file-excel text-success", // Excel icon in green
																".ppt" or ".pptx" => "fa-solid fa-file-powerpoint text-warning", // PowerPoint icon
																".txt" => "fa-solid fa-file-lines text-secondary",  // Text file icon
																".jpg" or ".jpeg" or ".png" or ".gif" => "fa-solid fa-file-image text-info", // Image file
																".zip" or ".rar" => "fa-solid fa-file-zip text-muted", // Compressed file
																_ => "fa-solid fa-file text-gray-500" // Default file icon
															};
															<i class="@fileIconClass fs-2x me-4"></i>
														}
														else
														{
															<i class="fa-solid fa-file text-gray-500 fs-2x me-4"></i> <!-- Default file icon -->
														}

													</span>
													@* <a href="#" class="text-gray-800 text-hover-primary viewAttachment" keyID="@item.FileId">@item.FileName</a> *@
													@if (item.AttachmentAny)
													{
														<a href="@Url.Content("~" + item.FilePath)"
														   class="text-primary menu-link viewAttachment"
														   data-url="@Url.Content("~" + item.FilePath)"
														   style="text-decoration: none;">
															 @item.FileName
														</a>
													}
													else if (item.FileLink != null)
													{
														<a href="@(item.FileLink.StartsWith("http") ? item.FileLink : "https://" + item.FileLink)" target="_blank" rel="noopener noreferrer">@item.FileName</a>
													}
													else
													{
														@item.FileName
													}
												</div>
											</td>
												
											
											<td>@item.UpdatedOrCreatedDateformatted</td>

											<td>
												@if (string.IsNullOrEmpty(item.FileExtension))
												{
													<text>FileLink</text> <!-- Display file link if FileExtension is null -->
												}
												else
												{
													@if (item.FileExtension?.ToLower() == ".pdf")
													{
														<text>PDF Document</text>
													}
													else if (item.FileExtension?.ToLower() == ".xlsx")
													{
														<text>Microsoft Excel Worksheet</text>
													}
													else
													{
														<text>@item.FileExtension.TrimStart('.').ToUpper() File</text>

														<!-- Display other file types -->
													}
												}
											</td>

											<td>@item.ContentLength KB</td>
										</tr>

									}
								}
								else
								{
									<tr>
										<td colspan="3" class="text-center text-muted">No files found.</td>
									</tr>
								}
							</tbody>
						</table>
						</div>
						<!--end::Table-->
						<div class="col-12 text-end">
							<button id="btnBack" type="button" class="btn btn-secondary btn-flat btn-sm">
								<i class="fas fa-arrow-left"></i> Back
							</button>
						</div>
					</div>
					<!--end::Card body-->

				</div>
				<!--end::Content container-->

			</div>
			<!--end::Content-->

		</div>

		<!--end::Content wrapper-->
		<!--begin::Footer-->
		<nav aria-label="Page navigation">
			<ul class="pagination justify-content-center">
				<!-- Previous Button -->
				<li class="page-item @(Model.PageIndex == 1 ? "disabled" : "")">
					<a class="page-link" href="?pageIndex=@(Model.PageIndex - 1)" aria-label="Previous">
						<span aria-hidden="true">&laquo;</span>
					</a>
				</li>
				<!-- Page Numbers -->
				@for (int i = 1; i <= Model.TotalPages; i++)
				{
					<li class="page-item @(i == Model.PageIndex ? "active" : "")">
						<a class="page-link" href="?pageIndex=@i">@i</a>
					</li>
				}
				<!-- Next Button -->
				<li class="page-item @(Model.PageIndex == Model.TotalPages ? "disabled" : "")">
					<a class="page-link" href="?pageIndex=@(Model.PageIndex + 1)" aria-label="Next">
						<span aria-hidden="true">&raquo;</span>
					</a>
				</li>
			</ul>
		</nav>
		<!--end::Footer-->
	</div>
	<script type="text/javascript">
			$(function () {
				KTMenu.init()
				$('#txtSearchInputField').on('keydown', function (e) {
			if (e.key === 'Enter' || e.keyCode === 13) {
				e.preventDefault(); // Prevent form submission if inside a form
				$('.btnSearch').click(); // Trigger the search button click
			}
			});
			$(document).on('click', '.btnReset', function (e) {
			e.preventDefault();
			$('#txtSearchInputField').val('');
			$('.btnSearch').click(); // Trigger the search button click
		});
		$(document).on('click', '.btnSearch', function (e) {
			e.preventDefault(); // Prevent default behavior

			var searchText = $("#txtSearchInputField").val().trim(); // Get SearchText value
			var FolderId = $("#Folderid").val(); // Get FolderId from hidden field
			var FolderName=$("#FolderName").val();
			var pageCode = document.getElementById("hidPageCode").value;
			var url = $("#hidSearch").val() + "?searchText=" + encodeURIComponent(searchText) + "&id=" + encodeURIComponent(FolderId)+"&Foldername="+encodeURIComponent(FolderName)+"&pageCode=" + encodeURIComponent(pageCode);

			window.location.href = url; // Redirect to search page
		});
		$(document).on("click", ".viewAttachment", function (e) {
			alert('hi');
				   e.preventDefault();
				   // Get the image URL from the data-url attribute
				   let fileUrl = $(this).data("url"); // More reliable way to fetch data attributes
				   console.log("fileUrl to: "+fileUrl);
				   $("#hiddenFileUrl").val(fileUrl);
				let extension = fileUrl.substring(fileUrl.lastIndexOf('.')).toLowerCase();
						   
		console.log("Extracted extension: " + extension);
		if(extension=='.xlsx'||extension=='.docx'){
			$("#kt_app_main").hide(); // Hide the content
					$("#pdfViewerWrapperexcell").show();   // Show PDF viewer
		}
				   else if (fileUrl && fileUrl.trim() !== "") {
						 $("#kt_app_main").hide(); // Hide the content
					$("#pdfViewer").attr("src", fileUrl);
					$("#pdfViewerWrapper").show();   // Show PDF viewer
				   } else {
					   Swal.fire({
						   icon: "error",
						   title: "Attachment Not Found",
						   text: "The file URL is missing or invalid.",
						   confirmButtonColor: "#d33"
					   });
				   }
		   });
		$(document).on("click", "#btnBack", function (e) {
			
			const pageCode = document.getElementById("hidPageCode").value;
			if (pageCode === "C003"||pageCode === "C005"||pageCode === "C008"||pageCode === "C0010"||pageCode === "C0013") {
				window.location.href = '@Url.Content("~/Activity_Sheet/index")' + '?pageCode=' + pageCode;
			} else if (pageCode === "C009"||pageCode === "C006"||pageCode === "C0014"||pageCode === "C0011") {
				window.location.href = '@Url.Content("~/File_Manager/index")' + '?pageCode=' + pageCode;
			}
			 else if (pageCode === "C004"||pageCode === "C007"||pageCode === "C0012"||pageCode === "C0015") {
				window.location.href = '@Url.Content("~/Knowledge_Base/index")' + '?pageCode=' + pageCode;
			}
			 else if (pageCode === "C0017") {
				window.location.href = '@Url.Content("~/PoliciesAndTemplate/index")' + '?pageCode=' + pageCode;
			}
			else{
			window.location.href = '@Url.Content("~/Library/index")' + '?pageCode=' + pageCode;
			}
			});

			});

	</script>
