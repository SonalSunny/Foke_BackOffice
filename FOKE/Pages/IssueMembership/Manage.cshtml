@page
@model FOKE.Pages.IssueMembership.ManageModel
@using FOKE.Localization
@using FOKE.Models.PageModels

@inject ISharedLocalizer Localize
<form method="post" id="crudForm" novalidate="novalidate" autocomplete="off" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <input type="hidden" id="hidManagePageUrl" value="@Url.Content("~/IssueMembership/Manage")" />
    <div class="card">

        <div class="card-header cursor-pointer border-bottom" role="button">
            <div class="card-title m-0">
                @if (Model.formMode.Equals(FormModeEnum.add))
                {
                     <h3 class="fw-bold m-0">
                        @Localize.Localize("Issue Membership")
                   
                     </h3>
                }
                else
                {
                     <h3 class="fw-bold m-0">
                        @Localize.Localize("Edit Registration Data")
                     </h3>
                }

            </div>
            <div class="d-flex align-items-center gap-2 gap-lg-3">
                <div class="m-0">
                </div>
               
            </div>
        </div>



        <div class="card-body">
            <div class="col-12" id="response">
                @if (!string.IsNullOrEmpty(Model.pageErrorMessage))
                {
                    <input type="hidden" asp-for="Issueid" />
                    <div class="alert alert-dismissible fade show bg-light-danger border border-light-danger shadow-lg rounded-3 p-3 w-100 d-flex flex-column align-items-center text-center" role="alert">
                        <i class="ki-duotone ki-info-circle fs-2 text-danger me-3"></i>
                        <div class="flex-grow-1 fw-bold text-dark">
                            <strong></strong> @Model.pageErrorMessage
                        </div>
                        <button type="button" class="btn-close position-absolute top-50 end-0 translate-middle-y me-3" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
            </div>
            <input type="hidden" asp-for="_formMode" />
            <input type="hidden" asp-for="inputModel.IssueId" />
            <input type="hidden" asp-for="inputModel.loggedinUserId" value="@User.FindFirst("Userid")?.Value" />
            <input type="hidden" asp-for="inputModel.MembershipId" />
         

            <div class="border rounded p-4 mb-4 bg-light">

                <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary">
                    <i class="bi bi-person-lines-fill me-2"></i> Personal Information
                </h4>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Name")</label>
                            <input asp-for="inputModel.Name" class="form-control form-control-sm" id="NameInput" maxlength="100" />
                            <span asp-validation-for="inputModel.Name" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Civil ID")</label>
                            <input asp-for="inputModel.CivilId" class="form-control form-control-sm" id="CivilIdInput" maxlength="12" />
                            <span id="civilIdError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.CivilId" class="text-danger"></span>
                        </div>
                    </div>

                    @if (Model.formMode.Equals(FormModeEnum.add))
                    {

                        <div class="col-md-4  mb-3">
                            <div class="form-group">
                                <label class="required form-label-new">@Localize.Localize("Date of Birth")</label>
                                <input type="text" class="form-control form-control-sm" id="DOBDisplay" placeholder="DD-MM-YYYY" disabled />
                                <input asp-for="inputModel.DateofBirth" type="hidden" id="DOBInput" />
                                <span asp-validation-for="inputModel.DateofBirth" class="text-danger"></span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="col-md-4  mb-3">
                            <div class="form-group">
                                <label class="required form-label-new">@Localize.Localize("Date of Birth")</label>
                                <input asp-for="inputModel.DateofBirthString" class="form-control form-control-sm" placeholder="DD-MM-YYYY" disabled />
                                <input asp-for="inputModel.DateofBirth" type="hidden" id="DOBInput" />
                                <span asp-validation-for="inputModel.DateofBirthString" class="text-danger"></span>
                            </div>
                        </div>
                    }


                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Passport No")</label>
                            <input asp-for="inputModel.PassportNo" class="form-control form-control-sm" id="PassportInput" maxlength="8" />
                            <span id="PassportnoError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.PassportNo" class="text-danger"></span>
                        </div>
                    </div>


                    <div class="col-md-4  mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Gender")</label>
                            <select asp-for="inputModel.GenderId"
                                    class="form-select form-select-sm"
                                    asp-items='@new SelectList(Model.GenderList, "keyID", "name")'>
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.GenderId" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4  mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Blood Group")</label>
                            <select asp-for="inputModel.BloodGroupId"
                                    class="form-select form-select-sm"
                                    asp-items='@new SelectList(Model.BloodGroupList, "keyID", "name")'>
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.BloodGroupId" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Contact Number")</label>
                            <div class="input-group">
                                <select asp-for="inputModel.CountryCodeId" class="form-select form-select-sm NoDdl">
                                    <option value="+965">+965 🇰🇼</option>
                                    <option value="+91">+91 🇮🇳</option>
                                </select>
                                <input asp-for="inputModel.ContactNo" class="form-control form-control-sm" placeholder=@Localize.Localize("Enter phone number") />
                            </div>

                            <span id="ContactNoError" class="text-danger" style="display: none;"></span>
                            <span asp-validation-for="inputModel.ContactNo" class="text-danger"></span>
                        </div>
                    </div>


                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("WhatsApp Number")</label>
                            <div class="input-group">
                                <select asp-for="inputModel.WhatsAppNoCountryCodeid" class="form-select form-select-sm NoDdl">
                                    <option value="+965">+965 🇰🇼</option>
                                    <option value="+91">+91 🇮🇳</option>
                                </select>
                                <input asp-for="inputModel.WhatsAppNo" class="form-control form-control-sm" placeholder=@Localize.Localize("Enter WhatsApp number") />
                            </div>
                            <span id="WhatsAppNoError" class="text-danger" style="display: none;"></span>
                            <span asp-validation-for="inputModel.WhatsAppNo" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4  mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Email")</label>
                            <input asp-for="inputModel.Email" class="form-control form-control-sm" id="EmailInput" placeholder="Enter Email" />
                            <span id="EmailidPersonalError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.Email" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4  mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Profession")</label>
                            <select asp-for="inputModel.ProfessionId"
                                    class="form-select form-select-sm select2"
                                    asp-items='@new SelectList(Model.ProfesssionList, "keyID", "name")' id="ProfessionDDL">
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.ProfessionId" class="text-danger" id="ProfessionDDLError"></span>
                        </div>
                    </div>

                    <div class="col-md-4  mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Company Name")</label>
                            <input asp-for="inputModel.Company" class="form-control form-control-sm" placeholder="Enter Company Name" />
                            <span asp-validation-for="inputModel.Company" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4  mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Area")</label>
                            <select asp-for="inputModel.AreaId"
                                    class="form-select form-select-sm select2"
                                    asp-items='@new SelectList(Model.AreaList, "keyID", "name")' id="AreaDDL">
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.AreaId" class="text-danger" id="AreaDDLError"></span>
                        </div>
                    </div>

                    <div class="col-md-12  mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Address in Kuwait")</label>
                            <textarea asp-for="inputModel.KuwaitAddress" class="form-control form-control-sm" placeholder="Enter Kuwait Address"></textarea>
                            <span asp-validation-for="inputModel.KuwaitAddress" class="text-danger"></span>
                        </div>
                    </div>
                    @if (Model.formMode.Equals(FormModeEnum.add))
                    {
                        <div class="col-md-6  mb-3">
                            <div class="form-group">
                                <label class="form-label-new">@Localize.Localize("Profile Image")</label>
                                <input asp-for="inputModel.Attachment" id="pdfUpload" type="file" class="form-control form-control-sm" multiple />
                                <span asp-validation-for="inputModel.Attachment" class="text-danger"></span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="border rounded p-4 mb-4 bg-light">
                
               <!-- Membership Type -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="required form-label-new mb-2">Membership Type</label>
                        <div class="form-check">
                            <input type="radio" name="MembershipType" class="form-check-input" value="1" id="membershipSingle" />
                            <label class="form-check-label" for="membershipSingle">Single</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="MembershipType" class="form-check-input" value="2" id="membershipFamily" />
                            <label class="form-check-label" for="membershipFamily">Family</label>
                        </div>
                    </div>
                </div>
            </div>



            <div id="familyDetailsContainer" class="mt-2" style="display:none;">

                <div class="row">
                    <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary">
                        <i class="fa fa-users me-2"></i>Family Details
                    </h4>

                    <div class="border rounded p-4 mb-4 bg-light">

                        <div class="d-flex justify-content-end mb-2">
                            <button type="button" id="addFamilyForm" class="btn btn-outline-primary btn-sm ">
                                <i class="fa fa-plus me-1"></i> Add Another
                            </button>
                        </div>

                        <div id="familyForms">
                            <!-- First Family Member Form (index 0) -->
                            <div id="familyForms">
                                @if (Model?.inputModel?.FamilyData != null && Model.inputModel.FamilyData.Any())
                                {
                                    for (int i = 0; i < Model.inputModel.FamilyData.Count; i++)
                                    {
                                        <div class="card mb-3 family-form">
                                            <div class="card-body">
                                                    <input type="hidden" name="inputModel.FamilyData[@i].IsChanged" value="false" class="is-changed-flag" />
                                                <input type="hidden" name="inputModel.FamilyData[@i].IsNew" value="false" class="is-new-flag" />

                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label class="required form-label-new">Name</label>
                                                        <input asp-for="inputModel.FamilyData[@i].Name" class="form-control form-control-sm family-name" />
                                                        <span asp-validation-for="inputModel.FamilyData[@i].Name" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="required form-label-new">Relation</label>
                                                        <select asp-for="inputModel.FamilyData[@i].RelationType"
                                                                class="form-select form-select-sm"
                                                                asp-items='@new SelectList(Model.RelationTypeList, "keyID", "name", Model.inputModel.FamilyData[i].RelationType)'>
                                                            <option value="">Select</option>
                                                        </select>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].RelationType" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="required form-label-new">Civil ID</label>
                                                        <input asp-for="inputModel.FamilyData[@i].CivilId" class="form-control form-control-sm family-civilid" maxlength="12" />
                                                        <span class="text-danger civilIdErrorFamily" style="display:none;"></span>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].CivilId" class="text-danger"></span>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label class="required form-label-new">Passport No</label>
                                                        <input asp-for="inputModel.FamilyData[@i].PassportNo" class="form-control form-control-sm family-passport" maxlength="8" />
                                                        <span class="text-danger passportErrorFamily" style="display:none;"></span>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].PassportNo" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="required form-label-new">Blood Group</label>
                                                        <select asp-for="inputModel.FamilyData[@i].BloodGroupid"
                                                                class="form-select form-select-sm"
                                                                asp-items='@new SelectList(Model.BloodGroupList, "keyID", "name", Model.inputModel.FamilyData[i].BloodGroupid)'>
                                                            <option value="">Select</option>
                                                        </select>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].BloodGroupid" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="required form-label-new">Mobile Number</label>
                                                        <div class="input-group">
                                                            <select asp-for="inputModel.FamilyData[@i].CountryCodeid" class="form-select form-select-sm NoDdl">
                                                                <option value="+965" selected="@(Model.inputModel.FamilyData[i].CountryCodeid == 965)">+965 🇰🇼</option>
                                                                <option value="+91" selected="@(Model.inputModel.FamilyData[i].CountryCodeid == 91)">+91 🇮🇳</option>
                                                            </select>
                                                            <input asp-for="inputModel.FamilyData[@i].MobileNoRelative" class="form-control form-control-sm family-mobile" />
                                                        </div>
                                                        <span id="RelativeNoError_@i" class="text-danger" style="display: none;"></span>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].MobileNoRelative" class="text-danger"></span>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label class="form-label-new">Email</label>
                                                        <input asp-for="inputModel.FamilyData[@i].EmailRelative" class="form-control form-control-sm family-email" />
                                                        <span id="EmailRelativeError_@i" class="text-danger" style="display:none;"></span>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].EmailRelative" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="form-label-new">Profession (Optional)</label>
                                                        <select asp-for="inputModel.FamilyData[@i].Professionid"
                                                                class="form-select form-select-sm family-profession"
                                                                asp-items='@new SelectList(Model.ProfesssionList, "keyID", "name", Model.inputModel.FamilyData[i].Professionid)'>
                                                            <option value="">Select</option>
                                                        </select>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].Professionid" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="form-label-new">Company (Optional)</label>
                                                        <input asp-for="inputModel.FamilyData[@i].CompanyName" class="form-control form-control-sm family-company" />
                                                        <span asp-validation-for="inputModel.FamilyData[@i].CompanyName" class="text-danger"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <!-- If no existing family, show one empty form -->
                                    <div class="card mb-3 family-form">
                                        <div class="card-body">

                                            <input type="hidden" name="inputModel.FamilyData[0].IsChanged" value="true" class="is-changed-flag" />
                                            <input type="hidden" name="inputModel.FamilyData[0].IsNew" value="true" class="is-new-flag" />

                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="required form-label-new">Name</label>
                                                    <input asp-for="inputModel.FamilyData[0].Name" class="form-control form-control-sm family-name" placeholder="Enter family member name" />
                                                    <span asp-validation-for="inputModel.FamilyData[0].Name" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="required form-label-new">Relation</label>
                                                    <select asp-for="inputModel.FamilyData[0].RelationType"
                                                            class="form-select form-select-sm"
                                                            asp-items='@new SelectList(Model.RelationTypeList, "keyID", "name")' id="RelationDDL">
                                                        <option value="">Select</option>
                                                    </select>
                                                    <span asp-validation-for="inputModel.FamilyData[0].RelationType" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="required form-label-new">Civil ID</label>
                                                    <input asp-for="inputModel.FamilyData[0].CivilId" class="form-control form-control-sm family-civilid" maxlength="12" placeholder="Enter Civil ID" />
                                                    <span class="text-danger civilIdErrorFamily" style="display:none;"></span>
                                                    <span asp-validation-for="inputModel.FamilyData[0].CivilId" class="text-danger"></span>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="required form-label-new">Passport No</label>
                                                    <input asp-for="inputModel.FamilyData[0].PassportNo" class="form-control form-control-sm family-passport" maxlength="8" placeholder="Enter Passport No" />
                                                    <span class="text-danger passportErrorFamily" style="display:none;"></span>
                                                    <span asp-validation-for="inputModel.FamilyData[0].PassportNo" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="required form-label-new">Blood Group</label>
                                                    <select asp-for="inputModel.FamilyData[0].BloodGroupid"
                                                            class="form-select form-select-sm"
                                                            asp-items='@new SelectList(Model.BloodGroupList, "keyID", "name")' id="BloodGroupDDL">
                                                        <option value="">Select</option>
                                                    </select>
                                                    <span asp-validation-for="inputModel.FamilyData[0].BloodGroupid" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="form-label-new">Mobile Number(Optional For Minors)</label>
                                                    <div class="input-group">
                                                        <select asp-for="inputModel.FamilyData[0].CountryCodeid" class="form-select form-select-sm NoDdl" id="FamilyCountryDDL">
                                                            <option value="+965" selected>+965 🇰🇼</option>
                                                            <option value="+91">+91 🇮🇳</option>
                                                        </select>
                                                        <input asp-for="inputModel.FamilyData[0].MobileNoRelative" class="form-control form-control-sm family-mobile" placeholder="Enter phone number" />
                                                    </div>
                                                    <span id="RelativeNoError" class="text-danger" style="display: none;"></span>
                                                    @* <span asp-validation-for="inputModel.FamilyData[0].MobileNoRelative" class="text-danger"></span> *@
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label-new">Email(Optional For Minors)</label>
                                                    <input asp-for="inputModel.FamilyData[0].EmailRelative" type="email" class="form-control form-control-sm family-email" placeholder="Enter Email" required />
                                                    <span id="EmailRelativeError" class="text-danger" style="display:none;"></span>
                                                    <span class="text-danger"></span>
                                                </div>

@*                                                 <div class="col-md-4">
                                                    <label class="form-label-new">Email(Optional)</label>
                                                    <input type="email" name="inputModel.FamilyData[${index}].EmailRelative" class="form-control form-control-sm family-email" required />
                                                    <span id="EmailRelativeError_${index}" class="text-danger" style="display:none;"></span>
                                                    <span class="text-danger"></span>
                                                </div> *@

                                                <div class="col-md-4">
                                                    <label class="form-label-new">Profession (Optional For Minors)</label>
                                                    <select asp-for="inputModel.FamilyData[0].Professionid"
                                                            class="form-select form-select-sm family-profession"
                                                            asp-items='@new SelectList(Model.ProfesssionList, "keyID", "name")' id="ProfessionDDL_Family">
                                                        <option value="">Select</option>
                                                    </select>
                                                    <span asp-validation-for="inputModel.FamilyData[0].Professionid" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="form-label-new">Company (Optional For Minors)</label>
                                                    <input asp-for="inputModel.FamilyData[0].CompanyName" class="form-control form-control-sm family-company" placeholder="Enter Company Name" />
                                                    <span asp-validation-for="inputModel.FamilyData[0].CompanyName" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>



                            
                            <!-- /First form -->
                        </div>
                    </div>
                </div>
            </div>
            
            <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary">
                <i class="fa fa-home me-2"></i>Kerala Details
            </h4>

            <div class="border rounded p-4 mb-4 bg-light">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label class="required form-label"> Permanent Address</label>
                            <textarea asp-for="inputModel.PermenantAddress" class="form-control form-control-sm" placeholder="Enter Permanent Address"></textarea>
                            <span asp-validation-for="inputModel.PermenantAddress" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Pincode")</label>
                            <input asp-for="inputModel.Pincode" class="form-control form-control-sm" placeholder="Enter Pincode" />
                            <span asp-validation-for="inputModel.Pincode" class="text-danger"></span>
                        </div>
                    </div>

                </div>
            </div>

            <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary">
                <i class="bi bi-person-rolodex"></i> Emergency contact Details
            </h4>

            <div class="border rounded p-4 bg-light">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Name")</label>
                            <input asp-for="inputModel.EmergencyContactName" class="form-control form-control-sm" id="EmergencyContactNameInput" maxlength="100" placeholder="Enter Name" />
                            <span asp-validation-for="inputModel.EmergencyContactName" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Relation")</label>
                            <select asp-for="inputModel.EmergencyContactRelation"
                                    class="form-select form-select-sm"
                                    asp-items='@new SelectList(Model.RelationTypeList, "keyID", "name")' id="RelationDDL">
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.EmergencyContactRelation" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Mobile Number")</label>
                            <div class="input-group">
                                <select asp-for="inputModel.EmergencyContactCountryCodeid" class="form-select form-select-sm NoDdl">
                                    <option value="+965">+965 🇰🇼</option>
                                    <option value="+91">+91 🇮🇳</option>
                                </select>
                                <input asp-for="inputModel.EmergencyContactNumber" class="form-control form-control-sm" placeholder="Enter phone number" />
                            </div>

                            <span id="emergencyContactNoError" class="text-danger" style="display: none;"></span>
                            <span asp-validation-for="inputModel.EmergencyContactNumber" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Email")</label>
                            <input asp-for="inputModel.EmergencyContactEmail" class="form-control form-control-sm" id="EmailInputEmergencyContact" placeholder="Enter Email" />
                            <span id="EmergencyContactEmailError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.EmergencyContactEmail" class="text-danger"></span>
                        </div>
                    </div>

                </div>
            </div>

            @if (Model.formMode.Equals(FormModeEnum.edit))
            {
                <div class="col-6 text-end">
                    <button type="submit" name="btnSubmit" value="btnSave" id="btnSave" class="btn btn-primary btn-flat btn-sm "><i class="far fa-save"></i> @Localize.Localize("SAVE")</button>
                    <button type="submit" name="btnSubmit" id="btnRefresh" value="btnRefresh" class="btn btn-outline-primary btn-sm d-none " formnovalidate="formnovalidate">btnRefresh</button>
                </div>
            }

            @if (Model.formMode.Equals(FormModeEnum.add))
            {
                 <hr class="my-4" />

                <div class="border rounded p-4 bg-light">
                    <h5 class="fw-bold mb-4">@Localize.Localize("For Office Use Only")</h5>

                    <div class="row">

                         <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label class="form-label-new"> @Localize.Localize("Referred By")</label>
                                    <div class="input-group">
                                        <select asp-for="inputModel.SearchText"  id="searchColumn" class="form-select form-select-sm"
                                            asp-items='@new SelectList(Model.pageListFilterColumns, "ColumName", "ColumnDescription")'>
                                        </select>
                                        <input type="text" id="referredByInput" class="form-control form-control-sm" placeholder=@Localize.Localize("Referred By") />
                                        <input asp-for="inputModel.ReferredBy" type="hidden" id="SelectedMemberId" />
                                    </div>
                                    <span asp-validation-for="inputModel.ReferredBy" class="text-danger"></span>

                                    <!-- ✅ Add result container here -->
                                    <div id="resultsContainer" class="mt-2"></div>

                                    <!-- Hidden field to store selected ID -->
                                    <input type="hidden" id="SelectedMemberId" name="SelectedMemberId" />
                            </div>
                        </div>

                        <div class="col-md-6 mb-5">
                            <div class="form-group">
                                    <label class="required form-label-new">@Localize.Localize("Zone")</label>
                                    <select asp-for="inputModel.ZoneId" id="ZoneId"
                                            class="form-select form-select-sm select2"
                                            asp-items='@new SelectList(Model.ZoneList, "keyID", "name")'>
                                        <option value="">Select</option>
                                    </select>
                                    <span asp-validation-for="inputModel.ZoneId" class="text-danger" id="ZoneDDLError"></span>
                            </div>
                        </div>

                        <div class="col-md-6 mb-5">
                            <div class="form-group">
                                    <label class="required form-label-new"> @Localize.Localize("Unit")</label>
                                    <select asp-for="inputModel.UnitId"  id="UnitId"
                                            class="form-select form-select-sm select2"
                                            asp-items='@new SelectList(Model.UnitList, "keyID", "name")'>
                                        <option value="">Select</option>
                                    </select>
                                    <span asp-validation-for="inputModel.UnitId" class="text-danger" id="UnitDDLError"></span>
                            </div>
                        </div>

                        <div class="col-md-6  mb-3">
                            <div class="form-group">
                                <label class="required form-label-new">@Localize.Localize("Membership No")</label>
                                <input asp-for="inputModel.MembershipNo" class="form-control form-control-sm" placeholder="Enter Membership No" />
                                <span asp-validation-for="inputModel.MembershipNo" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4" />

                <div class="border rounded p-4 bg-light">
                        <h5 class="fw-bold mb-4"> @Localize.Localize("Fee Collection")</h5>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="form-group">
                                    <label class="required form-label-new"> @Localize.Localize("Campaign")</label>
                                <select asp-for="inputModel.CampaignId"  id="CampaignDropdown"  class="form-select form-select-sm select2 "> 
                                    <option value="">Select</option>
                                    @foreach (var campaign in Model.CampaignList)
                                    {
                                        <option value="@campaign.CampaignId" data-amount="@campaign.MemberShipFee">
                                            @campaign.CampaignName
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="inputModel.CampaignId" class="text-danger" id="CampaignDDLError"></span>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="form-group">
                                <div class="form-group">
                                        <label class="form-label-new"> @Localize.Localize("Campaign Amount")</label>
                                    <input asp-for="inputModel.CampaignAmount"  class="form-control form-control-sm" id="CampaignAmount"  disabled/>
                                    <span asp-validation-for="inputModel.CampaignAmount" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="form-group">
                                <div class="form-group">
                                        <label class="form-label-new"> @Localize.Localize("Amount Received") </label>
                                        <input asp-for="inputModel.AmountRecieved" class="form-control form-control-sm" id="RecievedAmount" placeholder=@Localize.Localize("Amount Received") />
                                    <span asp-validation-for="inputModel.AmountRecieved" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
              
                        <div class="col-md-6 mb-4">
                            <div class="form-group">
                                    <label class="form-label-new"> @Localize.Localize("Payment Type")</label>
                                <select asp-for="inputModel.PaymentTypeId" id="PaymentType" 
                                        class="form-select form-select-sm select2"
                                        asp-items='@new SelectList(Model.PaymentTypeList, "keyID", "name")'>
                                    <option value="">Select</option>
                                </select>
                                <span asp-validation-for="inputModel.PaymentTypeId" class="text-danger" id="PaymentTypeDDLError"></span>
                            </div>
                        </div>

                        <div class="col-md-12 mb-4">
                            <div class="form-group">
                                    <label class=" form-label-new"> @Localize.Localize("Payment Remarks") </label>
                                <textarea asp-for="inputModel.PaymentRemarks" class="form-control form-control-sm" id="PaymentRemark"  placeholder=@Localize.Localize("Payment Remarks")></textarea>
                                <span asp-validation-for="inputModel.PaymentRemarks" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>


                <hr class="my-4" />

                <div class="border rounded p-4 bg-light" id="requestActionContainer">
                    <h5 class="fw-bold mb-4">@Localize.Localize("Request Action")</h5>

                    <!-- Action and Reason Row -->
                    <div class="row mb-4">
                        <!-- Action Dropdown -->
                        <div class="col-md-6">
                                <label for="requestActionDropdown" class="form-label">@Localize.Localize("Action")</label>
                            <select id="requestActionDropdown" class="form-select form-select-sm">
                                <option value="" selected disabled>Select an action</option>
                                <option value="accept">Accept</option>
                                <option value="reject">Reject</option>
                            </select>
                        </div>

                        <!-- Reason Dropdown (only visible when rejected) -->
                        <div class="col-md-6 d-none" id="rejectReasonCol">
                                <label for="reqRejectionReason" class="form-label">@Localize.Localize("Reason")</label>
							        <select asp-for="inputModel.RejectionReasonId" id="reqRejectionReason" class="form-select form-select-sm"
                                            class="form-select form-select-sm select2"
                                            asp-items='@new SelectList(Model.RejectedReasonList, "keyID", "name")'>
                                        <option value="">Select</option>
                                    </select>
                        </div>
                    </div>

                    <!-- Remarks Row -->
                    <div class="row mb-4 d-none" id="rejectRemarksRow">
                        <div class="col-12">
                                <label for="reqRejectionNotes" class="form-label">@Localize.Localize("Rejection Remarks")</label>
                            <textarea id="reqRejectionNotes" class="form-control form-control-sm" rows="2" placeholder="Enter rejection remarks..."></textarea>
                        </div>
                    </div>

                    <!-- Accept Panel -->
                    <div id="reqAcceptDetails" class="d-none">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="reqTermsCheckbox">
                            <label class="form-check-label" for="reqTermsCheckbox">
                                Following the successful verification of the provided information, the membership is hereby approved and issued.
                            </label>
                        </div>
                        <div class="text-center">
                            <button type="button" class="btn btn-success" id="reqConfirmIssueBtn" disabled>Confirm Issue</button>
                        </div>
                    </div>

                    <!-- Reject Button -->
                    <div class="text-center d-none" id="reqRejectBtnContainer">
                        <button type="button" class="btn btn-danger" id="reqRejectConfirmBtn">Reject</button>
                    </div>
                </div>
            }
        </div>
    </div>
    <input type="hidden" name="ActionStatus" id="hiddenActionStatus" />
    <input type="hidden" name="RejectionReason" id="hiddenRejectionReason" />
    <input type="hidden" name="RejectionRemarks" id="hiddenRejectionRemarks" />
</form>


<link href="~/css/select2.min.css" rel="stylesheet" />
<script src="~/js/jquery-3.6.0.min.js"></script>
<script src="~/js/select2.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.12/dist/jquery.validate.unobtrusive.min.js"></script>

@section scripts {
    <partial name="_ValidationScriptsPartial" />

    <script type="text/javascript">

            var relationTypeOptions = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                    Model.RelationTypeList.Select(x => new { id = x.keyID, name = x.name })
            ));

            var bloodGroupOptions = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                        Model.BloodGroupList.Select(x => new { id = x.keyID, name = x.name })
            ));

            var professionOptions = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                        Model.ProfesssionList.Select(x => new { id = x.keyID, name = x.name })
            ));

        $(document).ready(function () {
            const isAddMode = '@Model.formMode' === 'add';
            const membershipId = $("#inputModel_MembershipId").val() || 0;

            $.validator.unobtrusive.parse("#crudForm");
            $('.select2').select2();

            // ============================================================
            // PRELOADS
            // ============================================================
            const SelectedCampaign = parseInt('@ViewData["SelectedCampaign"]');
            if (SelectedCampaign > 0) {
                setTimeout(function () {
                    $('#CampaignDropdown').val(SelectedCampaign).trigger('change');
                    $('#CampaignDropdown').trigger({
                        type: 'select2:select',
                        params: { data: $('#CampaignDropdown').find('option:selected').data() }
                    });
                }, 100);
            }

            const hiddenDob = $("#DOBInput").val();
            if (hiddenDob) {
                const parts = hiddenDob.split("-");
                if (parts.length === 3) {
                    const formattedDob = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    $("#DOBDisplay").val(formattedDob);
                    $("#inputModel_DateofBirthString").val(formattedDob);
                }
            }

            // Prevent Enter submit
            $('#crudForm input').on('keypress', function (e) {
                if (e.which === 13) { e.preventDefault(); return false; }
            });

            // ============================================================
            // SUCCESS REDIRECT
            // ============================================================
            if ("@Model.IsSuccessReturn" == "True") {
                Swal.fire({
                    icon: 'success',
                    title: "@Html.Raw(@Model.sucessMessage)",
                    showConfirmButton: false,
                    timer: 1500
                });
                setTimeout(() => window.location.href = '/IssueMembership/Index', 1500);
            }

            // ============================================================
            // CAMPAIGN AMOUNT AUTO-FILL
            // ============================================================
            $('#CampaignDropdown').on('select2:select', function () {
                const amount = $(this).find('option:selected').data('amount');
                $('#CampaignAmount').val(amount ?? 0);
            });

            // ============================================================
            // VALIDATIONS - PERSONAL SECTION
            // ============================================================

            // Name (letters only)
            $('#NameInput').on('input', function () {
                this.value = this.value.replace(/[^A-Za-z ]/g, '');
            });

            // Civil ID validation + AJAX
            $('#CivilIdInput').on('input', function () {
                this.value = this.value.replace(/[^0-9]/g, '');
            }).on('change', function () {
                const civilId = $(this).val();
                if (!/^\d{12}$/.test(civilId)) {
                    showError('#civilIdError', 'Civil ID must be 12 digits.');
                    $(this).addClass('is-invalid');
                    return;
                }
                $.ajax({
                    url: '@Url.Page("Manage", "ValidateCivilId")',
                    type: 'GET',
                    data: { civilId: civilId, membershipId: membershipId },
                    success: function (data) {
                        if (data.status === 1) showError('#civilIdError', 'Invalid Civil ID.');
                        else if (data.status === 2) showError('#civilIdError', 'Civil ID already exists.');
                        else if (data.status === 3) {
                            hideError('#civilIdError');
                            $('#CivilIdInput').removeClass('is-invalid');
                            extractDOB(civilId); 
                        }
                    }
                });
            });

            // Passport (alnum uppercase)
            $('#PassportInput').on('input', function () {
                this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
            }).on('change', function () {
                const passport = $(this).val();
                if (!passport) return;
                $.ajax({
                    url: '@Url.Page("Manage", "ValidatePassportNo")',
                    type: 'GET',
                    data: { passportNo: passport, membershipId: membershipId },
                    success: function (data) {
                        if (data.status === 1) showError('#PassportnoError', 'Invalid Passport No.');
                        else if (data.status === 2) showError('#PassportnoError', 'Passport already exists.');
                        else hideError('#PassportnoError');
                    }
                });
            });

            // Email validation
            $('#EmailInput').on('change', function () {
                const email = $(this).val();
                const regex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-z]{2,}$/;
                if (!regex.test(email)) showError('#EmailidPersonalError', 'Invalid email address.');
                else hideError('#EmailidPersonalError');
            });

            // Contact & WhatsApp number validations
            setupPhoneValidation('[name="inputModel.CountryCodeId"]', '[name="inputModel.ContactNo"]', '#ContactNoError', 'ValidateContactNo');
            setupPhoneValidation('[name="inputModel.WhatsAppNoCountryCodeid"]', '[name="inputModel.WhatsAppNo"]', '#WhatsAppNoError','ValidateContactNo');

            // Kerala details
            $('textarea[name="inputModel.PermenantAddress"]').on('blur', function () {
                if (!$(this).val().trim()) markInvalid(this, null, 'Permanent address is required.');
                else clearInvalid(this, null);
            });
            $('input[name="inputModel.Pincode"]').on('input', function () {
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value.length !== 6) markInvalid(this, null, 'Pincode must be 6 digits.');
                else clearInvalid(this, null);
            });

            // Emergency contact validations
            $('#EmergencyContactNameInput').on('input', function () { this.value = this.value.replace(/[^A-Za-z ]/g, ''); });
            setupPhoneValidation('[name="inputModel.EmergencyContactCountryCodeid"]', '[name="inputModel.EmergencyContactNumber"]', '#emergencyContactNoError', 'ValidateContactNo');
            
            $('#EmailInputEmergencyContact').on('change', function () {
                const email = $(this).val();
                const regex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-z]{2,}$/;
                if (!regex.test(email)) showError('#EmergencyContactEmailError', 'Invalid email address.');
                else hideError('#EmergencyContactEmailError');
            });

            // ============================================================
            // FAMILY SECTION VALIDATIONS
            // ============================================================
            function setupFamilyMemberValidations(container) {
                // Civil ID validation for family members
                $(container).on('input', '.family-civilid', function () {
                    this.value = this.value.replace(/[^0-9]/g, '');
                }).on('change', '.family-civilid', function () {
                    const civilId = $(this).val();
                    const errorSpan = $(this).siblings('.civilIdErrorFamily');
                    const inputField = $(this);
                    
                    if (!/^\d{12}$/.test(civilId)) {
                        errorSpan.text('Civil ID must be 12 digits.').show();
                        inputField.addClass('is-invalid');
                        return;
                    }
                    
                    // Use membershipId = 0 for family members (treat as new)
                    $.ajax({
                        url: '@Url.Page("Manage", "ValidateCivilId")',
                        type: 'GET',
                        data: { civilId: civilId, membershipId: 0 },  // Always 0 for family
                        success: function (data) {
                            if (data.status === 1) {
                                errorSpan.text('Invalid Civil ID.').show();
                                inputField.addClass('is-invalid');
                            } else if (data.status === 2) {
                                errorSpan.text('Civil ID already exists.').show();
                                inputField.addClass('is-invalid');
                            } else if (data.status === 3) {
                                errorSpan.text('').hide();
                                inputField.removeClass('is-invalid');
                            }
                        },
                        error: function() {
                            errorSpan.text('Validation failed. Please try again.').show();
                            inputField.addClass('is-invalid');
                        }
                    });
                });

                // Passport validation for family members
                $(container).on('input', '.family-passport', function () {
                    this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                }).on('change', '.family-passport', function () {
                    const passport = $(this).val();
                    const errorSpan = $(this).siblings('.passportErrorFamily');
                    const inputField = $(this);
                    
                    if (!passport) {
                        errorSpan.text('').hide();
                        inputField.removeClass('is-invalid');
                        return;
                    }
                    
                    // Use membershipId = 0 for family members
                    $.ajax({
                        url: '@Url.Page("Manage", "ValidatePassportNo")',
                        type: 'GET',
                        data: { passportNo: passport, membershipId: 0 },  // Always 0 for family
                        success: function (data) {
                            if (data.status === 1) {
                                errorSpan.text('Invalid Passport No.').show();
                                inputField.addClass('is-invalid');
                            } else if (data.status === 2) {
                                errorSpan.text('Passport already exists.').show();
                                inputField.addClass('is-invalid');
                            } else {
                                errorSpan.text('').hide();
                                inputField.removeClass('is-invalid');
                            }
                        },
                        error: function() {
                            errorSpan.text('Validation failed. Please try again.').show();
                            inputField.addClass('is-invalid');
                        }
                    });
                });

                // Email validation for family members (optional)
                $(container).on('change', '.family-email', function () {
                    const email = $(this).val().trim();
                    const regex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-z]{2,}$/;
                    const inputField = $(this);
                    const errorSpan = inputField.siblings('span[id^="EmailRelativeError"]');
                    
                    // If email is empty, it's valid (optional field)
                    if (!email) {
                        errorSpan.text('').hide();
                        hideError('#EmailRelativeError')
                        inputField.removeClass('is-invalid');
                        return;
                    }
                    
                    // If email has value, validate format
                    if (!regex.test(email)) {
                        errorSpan.text('Invalid email address.').show();
                        inputField.addClass('is-invalid');
                    } else {
                        console.log("emailerror");
                        errorSpan.text('').hide();
                        inputField.removeClass('is-invalid');
                    }
                });

                // Phone validation for family members
                $(container).on('input', '.family-mobile', function () {
                    const countryCode = $(this).closest('.input-group').find('.NoDdl').val();
                    const maxLength = countryCode === "+91" ? 10 : 8;
                    let value = this.value.replace(/\D/g, '');
                    
                    if (value.length > maxLength) {
                        value = value.substring(0, maxLength);
                    }
                    this.value = value;
                    
                    const inputField = $(this);
                    const errorSpan = inputField.closest('.col-md-4').find('span[id^="RelativeNoError"]');
                    
                    if (value.length && value.length < maxLength) {
                        errorSpan.text('Enter a valid number.').show();
                        inputField.addClass('is-invalid');
                    } else if (value.length === maxLength) {
                        // AJAX check for duplicate phone numbers
                        $.ajax({
                            url: '/IssueMembership/Manage?handler=ValidateContactNo',
                            type: 'GET',
                            data: { contactNo: value, membershipId: 0 },
                            success: function (data) {
                                if (!data.isValid) {
                                    errorSpan.text('Number already exists.').show();
                                    inputField.addClass('is-invalid');
                                } else {
                                    errorSpan.text('').hide();
                                    inputField.removeClass('is-invalid');
                                }
                            }
                        });
                    } else {
                        errorSpan.text('').hide();
                        inputField.removeClass('is-invalid');
                    }
                });

                // Country code change handler
                $(container).on('change', '.NoDdl', function () {
                    const mobileInput = $(this).siblings('.family-mobile');
                    mobileInput.val('');
                    mobileInput.trigger('input');
                });

                // Name validation (letters only)
                $(container).on('input', '.family-name', function () {
                    this.value = this.value.replace(/[^A-Za-z ]/g, '');
                });
            }

            // Initialize validations for existing family forms
            setupFamilyMemberValidations('#familyForms');

            // ============================================================
            // ADD MODE REQUIRED VALIDATION
            // ============================================================
            if (isAddMode) {
                $('#crudForm').on('submit', function (e) {
                    let hasError = false;
                    if (!$('#ZoneId').val()) { markInvalid('#ZoneId', '#ZoneDDLError', 'Zone is required.'); hasError = true; }
                    if (!$('#UnitId').val()) { markInvalid('#UnitId', '#UnitDDLError', 'Unit is required.'); hasError = true; }
                    if (!$('#CampaignDropdown').val()) { markInvalid('#CampaignDropdown', '#CampaignDDLError', 'Campaign is required.'); hasError = true; }

                    const perAddr = $('textarea[name="inputModel.PermenantAddress"]').val().trim();
                    const pinVal = $('input[name="inputModel.Pincode"]').val().trim();
                    if (!perAddr || pinVal.length !== 6) hasError = true;

                    if (hasError) {
                        e.preventDefault();
                        Swal.fire('Validation Error', 'Please fill all required fields.', 'warning');
                    }
                });
            }

            // ============================================================
            // FAMILY SECTION TOGGLE + DYNAMIC FORMS
            // ============================================================
            initMembershipToggle();
            setupFamilyValidationToggle();
            initAddFamilyMember();
            setupFamilyChangeTracking();

            // ============================================================
            // REQUEST ACTION DROPDOWN
            // ============================================================
            $("#requestActionDropdown").change(function () {
                const action = $(this).val();

                if (action === "accept") {
                    $("#reqAcceptDetails").removeClass("d-none").show();
                    $("#rejectReasonCol, #rejectRemarksRow, #reqRejectBtnContainer").addClass("d-none").hide();
                } else if (action === "reject") {
                    $("#reqAcceptDetails").addClass("d-none").hide();
                    $("#rejectReasonCol, #rejectRemarksRow, #reqRejectBtnContainer").removeClass("d-none").show();
                } else {
                    $("#reqAcceptDetails, #rejectReasonCol, #rejectRemarksRow, #reqRejectBtnContainer")
                        .addClass("d-none").hide();
                }
            });

            // Enable Confirm Issue checkbox toggle
            $('#reqTermsCheckbox').change(function () {
                $('#reqConfirmIssueBtn').prop('disabled', !this.checked);
            });

            // Confirm / Reject button handling
            $('#reqConfirmIssueBtn').click(function () {
                $('#hiddenActionStatus').val('accept');
                $('#crudForm').submit();
            });
            $('#reqRejectConfirmBtn').click(function () {
                const reason = $('#reqRejectionReason').val();
                const notes = $('#reqRejectionNotes').val();
                if (!reason) {
                    Swal.fire('Warning', 'Please select a reason.', 'warning');
                    return;
                }
                $('#hiddenActionStatus').val('reject');
                $('#hiddenRejectionReason').val(reason);
                $('#hiddenRejectionRemarks').val(notes);
                $('#crudForm').submit();
            });

            // ============================================================
            // UTILITIES
            // ============================================================
            function showError(sel, msg) { $(sel).text(msg).show(); }
            function hideError(sel) { $(sel).text('').hide(); }
            function markInvalid(inputSel, errSel, msg) {
                $(inputSel).addClass('is-invalid');
                if (errSel) $(errSel).text(msg).show();
            }
            function clearInvalid(inputSel, errSel) {
                $(inputSel).removeClass('is-invalid');
                if (errSel) $(errSel).text('').hide();
            }

            function extractDOB(civilId) {
                if (!/^[23]\d{11}$/.test(civilId)) return;
                const dobPart = civilId.substring(1, 7);
                const yearPrefix = civilId.startsWith("2") ? "19" : "20";
                const yyyy = yearPrefix + dobPart.substring(0, 2);
                const mm = dobPart.substring(2, 4);
                const dd = dobPart.substring(4, 6);
                const formattedDate = `${dd}-${mm}-${yyyy}`;
                $('#DOBDisplay').val(formattedDate);
                $('#DOBInput').val(`${yyyy}-${mm}-${dd}`);
                $('#inputModel_DateofBirthString').val(formattedDate);
            }

            function setupPhoneValidation(codeSelector, inputSelector, errorSelector, apiEndpoint) {
                const codeSel = document.querySelector(codeSelector);
                const inputSel = document.querySelector(inputSelector);
                const errorSel = document.querySelector(errorSelector);
                if (!codeSel || !inputSel || !errorSel) return;

                function getMaxLength() { return codeSel.value === "+91" ? 10 : 8; }

                function validateAndCheck() {
                    let value = inputSel.value.replace(/\D/g, '');
                    const maxLength = getMaxLength();
                    if (value.length > maxLength) value = value.substring(0, maxLength);
                    inputSel.value = value;

                    if (value.length && value.length < maxLength) {
                        errorSel.textContent = "Enter a valid number.";
                        errorSel.style.display = "block";
                        return;
                    }

                    if (value.length === maxLength && apiEndpoint) {
                        const urlnew = `/IssueMembership/Manage?handler=${apiEndpoint}`;
                        $.ajax({
                            url: urlnew,
                            type: 'GET',
                            data: { contactNo: value, membershipId: membershipId },
                            success: function (data) {
                                if (!data.isValid) {
                                    errorSel.textContent = "Number already exists.";
                                    errorSel.style.display = "block";
                                } else {
                                    errorSel.textContent = "";
                                    errorSel.style.display = "none";
                                }
                            }
                        });
                    } else {
                        errorSel.textContent = "";
                        errorSel.style.display = "none";
                    }
                }

                inputSel.addEventListener("input", validateAndCheck);
                codeSel.addEventListener("change", function () {
                    inputSel.value = "";
                    validateAndCheck();
                });
            }
        }); // END DOCUMENT READY

        // ============================================================
        // FAMILY DYNAMIC LOGIC (Outside document.ready)
        // ============================================================
        function initMembershipToggle() {
            const existingFamilyCount = @((Model?.inputModel?.FamilyData?.Count ?? 0));
            const familyContainer = document.getElementById('familyDetailsContainer');
            const singleRadio = document.getElementById('membershipSingle');
            const familyRadio = document.getElementById('membershipFamily');
            if (!familyContainer) return;

            if ('@Model.formMode' === 'add') {
                singleRadio.checked = existingFamilyCount === 0;
                familyRadio.checked = existingFamilyCount > 0;
            } else {
                familyRadio.checked = existingFamilyCount > 0;
                singleRadio.checked = existingFamilyCount === 0;
            }

            const toggle = () => {
                familyContainer.style.display = familyRadio.checked ? 'block' : 'none';
            };
            singleRadio.addEventListener('change', toggle);
            familyRadio.addEventListener('change', toggle);
            toggle();
        }

        function setupFamilyValidationToggle() {
            const singleRadio = document.getElementById('membershipSingle');
            const familyRadio = document.getElementById('membershipFamily');
            const familyInputs = document.querySelectorAll('#familyForms input, #familyForms select, #familyForms textarea');

            function updateValidationState() {
                const isFamily = familyRadio.checked;

                familyInputs.forEach(input => {
                    if (isFamily) {
                        // Enable and make required
                        input.removeAttribute('disabled');
                        if (input.classList.contains('family-name') ||
                            input.classList.contains('family-civilid') ||
                            input.classList.contains('family-passport')) {
                            input.setAttribute('required', 'required');
                        }
                    } else {
                        // Disable and clear required
                        input.removeAttribute('required');
                        if (input.classList) input.classList.remove('is-invalid');
                        input.value = '';
                        input.setAttribute('disabled', 'disabled');
                    }
                });
            }

            // Attach event listeners
            if (singleRadio && familyRadio) {
                singleRadio.addEventListener('change', updateValidationState);
                familyRadio.addEventListener('change', updateValidationState);
                updateValidationState();
            }
        }

        function initAddFamilyMember() {
            let familyMemberCount = @((Model?.inputModel?.FamilyData?.Count ?? 1));
            const addBtn = document.getElementById('addFamilyForm');
            const container = document.getElementById('familyForms');
            if (!addBtn || !container) return;

            addBtn.addEventListener('click', function () {
                const index = familyMemberCount++;
                const newCard = document.createElement('div');
                newCard.className = 'card mb-3 family-form';
                newCard.innerHTML = `
                    <div class="card-body position-relative pt-10">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 remove-family-form">
                            <i class="fa fa-times"></i> Remove
                        </button>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="required form-label-new">Name</label>
                                <input type="text" name="inputModel.FamilyData[${index}].Name" class="form-control form-control-sm family-name" required />
                                <span class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label class="required form-label-new">Relation</label>
                                <select name="inputModel.FamilyData[${index}].RelationType" class="form-select form-select-sm" required>${getRelationTypeOptions()}</select>
                                <span class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label class="required form-label-new">Civil ID</label>
                                <input type="text" name="inputModel.FamilyData[${index}].CivilId" class="form-control form-control-sm family-civilid" maxlength="12" required />
                                <span class="text-danger civilIdErrorFamily" style="display:none;"></span>
                                <span class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="required form-label-new">Passport No</label>
                                <input type="text" name="inputModel.FamilyData[${index}].PassportNo" class="form-control form-control-sm family-passport" maxlength="8" required />
                                <span class="text-danger passportErrorFamily" style="display:none;"></span>
                                <span class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label class="required form-label-new">Blood Group</label>
                                <select name="inputModel.FamilyData[${index}].BloodGroupid" class="form-select form-select-sm" required>${getBloodGroupOptions()}</select>
                                <span class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-new">Mobile Number(Optional)</label>
                                <div class="input-group">
                                    <select name="inputModel.FamilyData[${index}].CountryCodeid" class="form-select form-select-sm NoDdl">
                                        <option value="+965" selected>+965 🇰🇼</option>
                                        <option value="+91">+91 🇮🇳</option>
                                    </select>
                                    <input type="text" name="inputModel.FamilyData[${index}].MobileNoRelative" class="form-control form-control-sm family-mobile" required />
                                </div>
                                <span id="RelativeNoError_${index}" class="text-danger" style="display: none;"></span>
                                <span class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label-new">Email(Optional)</label>
                                <input type="email" name="inputModel.FamilyData[${index}].EmailRelative" class="form-control form-control-sm family-email" required />
                                <span id="EmailRelativeError_${index}" class="text-danger" style="display:none;"></span>
                                <span class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-new">Profession (Optional)</label>
                                <select name="inputModel.FamilyData[${index}].Professionid" class="form-select form-select-sm family-profession">${getProfessionOptions()}</select>
                                <span class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-new">Company (Optional)</label>
                                <input type="text" name="inputModel.FamilyData[${index}].CompanyName" class="form-control form-control-sm family-company" />
                                <span class="text-danger"></span>
                            </div>
                        </div>

                        <input type="hidden" name="inputModel.FamilyData[${index}].IsChanged" value="true" class="is-changed-flag" />
                        <input type="hidden" name="inputModel.FamilyData[${index}].IsNew" value="true" class="is-new-flag" />
                    </div>`;
                container.appendChild(newCard);
                $(newCard).find('.remove-family-form').on('click', () => newCard.remove());
                $.validator.unobtrusive.parse(newCard);
            });
        }

        function getRelationTypeOptions() {
            return  `<option value="">Select</option>` +
            relationTypeOptions
                .map(o => `<option value="${o.id}">${o.name}</option>`)
                .join('');
        }

        function getBloodGroupOptions() {
            return  `<option value="">Select</option>` +
            bloodGroupOptions
                .map(o => `<option value="${o.id}">${o.name}</option>`)
                .join('');
        }

        function getProfessionOptions() {
            return  `<option value="">Select</option>` +
            professionOptions
                .map(o => `<option value="${o.id}">${o.name}</option>`)
                .join('');
        }


        function setupFamilyChangeTracking() {
            const familyContainer = document.getElementById('familyForms');
            if (!familyContainer) return;

            $(familyContainer).on('input change', '.family-form input, .family-form select', function () {
                const card = $(this).closest('.family-form');
                const isNewFlag = card.find('.is-new-flag').val() === 'true';
                const isChangedInput = card.find('.is-changed-flag');

                // Only mark changed if it's an existing record (not new)
                if (!isNewFlag) {
                    isChangedInput.val('true');
                }
            });
        }
    </script>
}



