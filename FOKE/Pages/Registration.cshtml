@page
@model FOKE.Pages.RegistrationModel
@{
    Layout = "";
    ViewData["Title"] = "Registration Form";
}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Registration</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" >


        <!-- Open Graph Meta Tags -->
        <meta property="og:title" content="New Membership Registration" />
        <meta property="og:site_name" content="Keralites Medical Forum, Kuwait" />
        <meta property="og:url" content="https://portal.FOKEkuwait.com/NewMember" />
        <meta property="og:description" content="Join FOKE Kuwait, our awesome community of professionals! Become a member today." />
        <meta property="og:type" content="website" />
        <meta property="og:image" content="https://portal.FOKEkuwait.com/media/logos/FOKE_LOGO.png" />
        <meta property="og:image:secure_url" content="https://portal.FOKEkuwait.com/media/logos/FOKE_LOGO.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:alt" content="FOKE Association Banner" />
        <meta property="og:locale" content="en_US" />
        <meta property="og:logo" content="https://portal.FOKEkuwait.com/media/logos/FOKE_LOGO.png" />

        <!-- Twitter Card Meta Tags (Optional but Recommended) -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content="New Membership Registration" />
        <meta name="twitter:description" content="Join FOKE Kuwait, our awesome community of professionals! Become a member today." />
        <meta name="twitter:image" content="https://portal.FOKEkuwait.com/media/logos/FOKE_LOGO.png" />


        <link href="~/plugins/global/plugins.bundle.css" rel="stylesheet" />
        <link href="~/css/style.bundle.css" rel="stylesheet" />
        <link href="~/css/site.css" rel="stylesheet" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
        <link href="~/css/Registration.css" rel="stylesheet" />
    </head>
    <body>
        <div class="container py-5">
            <div class="registration-card">
                <div class="text-center mb-3">
                    <img src="~/media/logos/FOKE_LOGO.png" class="logo-img mb-3" alt="Association Logo" />
                    <h4 class="fw-bold">FRIENDS OF KANNUR KUWAIT EXPATS ASSOCIATION, KUWAIT</h4>
                    <p class="">
                        Indian Embassy Registration No.IDEMB/KWT/ASSN/37
                        <br /> Norka Registration No.KWT/09/102
                    </p>
                </div>
                <hr/>
                <h3 class="text-center mb-4">
                    Application Form For Membership And Welfare Fund
                </h3>
                <p class="text-center text-muted mb-5">* Please ensure all mandatory fields are Filled.</p>

                <form asp-action="Register" method="post">
                    <div class="col-12" id="response">
                        @if (!string.IsNullOrEmpty(Model?.pageErrorMessage))
                        {
                            <div class="alert alert-dismissible fade show bg-light-danger border border-light-danger shadow-lg rounded-3 p-3 w-100 d-flex flex-column align-items-center text-center" role="alert">
                                <i class="ki-duotone ki-info-circle fs-2 text-danger me-3 test-colo"></i>
                                <div class="flex-grow-1 fw-bold text-danger">
                                    <strong></strong> @Model.pageErrorMessage
                                </div>
                                <button type="button" class="btn-close position-absolute top-50 end-0 translate-middle-y me-3" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        }
                    </div>
                    @Html.AntiForgeryToken()
                     <input type="hidden" name="IsSuccessReturn" value="@Model.IsSuccessReturn" />

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="-0"><i class="fa fa-user"></i> Personal Details</h3>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Name</label>
                            <input asp-for="inputModel.Name" class="form-control form-control-sm" id="NameInput" maxlength="100" placeholder="Enter Name" />
                            <span asp-validation-for="inputModel.Name" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="required form-label">Civil ID</label>
                            <input asp-for="inputModel.CivilId" class="form-control form-control-sm" id="CivilIdInput" maxlength="12" placeholder="Enter Civil ID" />
                            <span id="civilIdError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.CivilId" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Date of Birth</label>
                            <input type="text" class="form-control form-control-sm" id="DOBDisplay" placeholder="DD-MM-YYYY" disabled />
                            <input asp-for="inputModel.DOB" type="hidden" id="DOBInput" />
                            <span asp-validation-for="inputModel.DOB" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label class="required form-label">Passport No</label>
                            <input asp-for="inputModel.PassportNo" class="form-control form-control-sm" id="PassportInput" maxlength="8" placeholder="Enter Passport No" />
                            <span id="PassportnoError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.PassportNo" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Gender</label>
                            <select asp-for="inputModel.Genderid"
                                    class="form-select form-select-sm"
                                    asp-items='@new SelectList(Model.GenderList, "keyID", "name")'>
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.Genderid" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="required form-label">Blood Group</label>
                            <select asp-for="inputModel.BloodGroupid"
                                    class="form-select form-select-sm"
                                    asp-items='@new SelectList(Model.BloodGroupList, "keyID", "name")'>
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.BloodGroupid" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Mobile Number</label>
                            <div class="input-group">
                                <select asp-for="inputModel.CountryCodeid" class="form-select form-select-sm NoDdl">
                                    <option value="+965">+965 🇰🇼</option>
                                    <option value="+91">+91 🇮🇳</option>
                                </select>
                                <input asp-for="inputModel.ContactNo" class="form-control form-control-sm" placeholder="Enter phone number" />
                            </div>

                            <span id="ContactNoError" class="text-danger" style="display: none;"></span>
                            <span asp-validation-for="inputModel.ContactNo" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label class="required form-label"> WhatsApp Number</label>
                            <div class="input-group">
                                <select asp-for="inputModel.WhatsAppNoCountryCodeid" class="form-select form-select-sm NoDdl">
                                    <option value="+965">+965 🇰🇼</option>
                                    <option value="+91">+91 🇮🇳</option>
                                </select>
                                <input asp-for="inputModel.WhatsAppNo" class="form-control form-control-sm" placeholder="Enter phone number" />
                            </div>
                            <span id="WhatsAppNoError" class="text-danger" style="display: none;"></span>
                            <span asp-validation-for="inputModel.WhatsAppNo" class="text-danger"></span>
                        </div>     
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Email</label>
                            <input asp-for="inputModel.Email" class="form-control form-control-sm" id="EmailInput" placeholder="Enter Email" />
                            <span id="EmailidError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.Email" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label class="required form-label" id="lblpro">Profession</label>
                            <label class="required form-label" id="lblproother" style="display:none;">Profession(Other)</label>
                            <select asp-for="inputModel.Professionid"
                                    class="form-select select2"
                                    asp-items='@new SelectList(Model.ProffessionList, "keyID", "name")' id="ProfessionDDL">
                                <option value="">Select</option>
                            </select>
                            <input asp-for="inputModel.ProffessionOther" class="form-control form-control-sm" id="ProfessionText" style="display:none" />
                            <span class="text-danger" id="ProfessionTextError" ></span>
                            <a href="javascript:void(0);" id="BackToDropdown" class="Change">
                                Change
                            </a>    
                            <span asp-validation-for="inputModel.Professionid" class="text-danger" id="ProfessionDDLError"></span>
                        </div>       
                    </div>


                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Company</label>
                            <input asp-for="inputModel.CompanyName" class="form-control form-control-sm"  placeholder="Enter Company Name" />
                            <span asp-validation-for="inputModel.CompanyName" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label  class="required form-label">Area</label>
                            <select asp-for="inputModel.Areaid"
                                    class="form-select form-select-sm select2" id="AreaDDL"
                                    asp-items='@new SelectList(Model.AreaList, "keyID", "name")'>
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.Areaid" class="text-danger" id="AreaDDLError"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="required form-label">Address in Kuwait</label>
                            <textarea asp-for="inputModel.KuwaitAddres" class="form-control form-control-sm" placeholder="Enter Kuwait Address"></textarea>
                            <span asp-validation-for="inputModel.KuwaitAddres" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">
                                Membership Type
                            </label>
                            <div class="form-check">
                                <input type="radio" asp-for="inputModel.MembershipType" class="form-check-input" value="1" id="membershipSingle" />
                                <label class="form-check-label" for="membershipSingle">Single</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" asp-for="inputModel.MembershipType" class="form-check-input" value="2" id="membershipFamily" />
                                <label class="form-check-label" for="membershipFamily">Family</label>
                            </div>
                        </div>
                    </div>

                    <!-- Family Details Section -->
                    <div id="familyDetailsContainer" class="mt-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4 class="mb-0"><i class="fa fa-users me-2"></i>Family Details</h4>

                            <button type="button" id="addFamilyForm" class="btn btn-outline-primary btn-sm">
                                <i class="fa fa-plus me-1"></i> Add Another
                            </button>
                        </div>

                        <div id="familyForms">
                            <!-- First Family Member Form -->
                            <div class="card mb-3 family-form">
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="required form-label">Name</label>
                                            <input asp-for="inputModel.FamilyData[0].Name" class="form-control form-control-sm" placeholder="Enter family member name" />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="required form-label">Relation</label>
                                            <select asp-for="inputModel.FamilyData[0].RelationType"
                                                    class="form-select form-select-sm"
                                                    asp-items='@new SelectList(Model.RelationTypeList, "keyID", "name")' id="RelationDDL">
                                                <option value="">Select</option>
                                            </select>
                                            <span asp-validation-for="inputModel.FamilyData[0].RelationType" class="text-danger"></span>
                                        </div>
                                    </div>

                                    <div class="row mb-3">

                                        <div class="col-md-6">
                                            <label class="required form-label">Civil ID</label>
                                            <input asp-for="inputModel.FamilyData[0].CivilId" class="form-control form-control-sm family-civilid" maxlength="12" placeholder="Enter Civil ID" />
                                            <span class="text-danger civilIdErrorFamily" style="display:none;"></span>
                                            <span asp-validation-for="inputModel.FamilyData[0].CivilId" class="text-danger"></span>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="required form-label">Passport No</label>
                                        <input asp-for="inputModel.FamilyData[0].PassportNo" class="form-control form-control-sm family-passport" id="RelativePassportInput" maxlength="8" placeholder="Enter Passport No" />
                                            <span class="text-danger passportErrorFamily" style="display:none;"></span>
                                            <span asp-validation-for="inputModel.FamilyData[0].PassportNo" class="text-danger"></span>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="required form-label">Blood Group</label>
                                            <select asp-for="inputModel.FamilyData[0].BloodGroupid"
                                                    class="form-select form-select-sm"
                                                    asp-items='@new SelectList(Model.BloodGroupList, "keyID", "name")'>
                                                <option value="">Select</option>
                                            </select>
                                            <span asp-validation-for="inputModel.FamilyData[0].BloodGroupid" class="text-danger"></span>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="required form-label">Mobile Number</label>
                                            <div class="input-group">
                                                <select asp-for="inputModel.FamilyData[0].CountryCodeid" class="form-select form-select-sm NoDdl">
                                                    <option value="+965">+965 🇰🇼</option>
                                                    <option value="+91">+91 🇮🇳</option>
                                                </select>
                                                <input asp-for="inputModel.FamilyData[0].MobileNoRelative" class="form-control form-control-sm" placeholder="Enter phone number" />
                                            </div>

                                            <span id="RelativeNoError" class="text-danger" style="display: none;"></span>
                                            <span asp-validation-for="inputModel.FamilyData[0].MobileNoRelative" class="text-danger"></span>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="required form-label">Email</label>
                                        <input asp-for="inputModel.FamilyData[0].EmailRelative" class="form-control form-control-sm" id="EmailInput" placeholder="Enter Email" />
                                        <span id="EmailRelativeError" class="text-danger" style="display:none;"></span>
                                        <span asp-validation-for="inputModel.FamilyData[0].EmailRelative" class="text-danger"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="required form-label">Profession</label>
                                        <select asp-for="inputModel.FamilyData[0].Professionid"
                                                    class="form-select form-select-sm"
                                                    asp-items='@new SelectList(Model.ProffessionList, "keyID", "name")'>
                                                <option value="">Select</option>
                                            </select>
                                        <span asp-validation-for="inputModel.FamilyData[0].Professionid" class="text-danger"></span>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label class="required form-label">Company</label>
                                        <input asp-for="inputModel.FamilyData[0].CompanyName" class="form-control form-control-sm" placeholder="Enter Company Name" />
                                        <span asp-validation-for="inputModel.FamilyData[0].CompanyName" class="text-danger"></span>
                                        </div>
                                    </div>

                                </div>                 
                            </div>
                        </div>
                    </div>
                    <!-- Family Details Section -->

                    <!-- Kerela Details Section -->
                    <div id="KerelaDetailsContainer" class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4 class="mb-0"><i class="fa fa-home me-2"></i>Kerela Details</h4>
                        </div>

                        <div id="KerelaForm">
                            <div class="card mb-3 family-form">
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label class="required form-label">
                                                Permenant Address
                                            </label>
                                        <textarea asp-for="inputModel.PermenantAddress" class="form-control form-control-sm" placeholder="Enter Permenant Address"></textarea>
                                        <span asp-validation-for="inputModel.PermenantAddress" class="text-danger"></span>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="required form-label">Pincode</label>
                                            <input asp-for="inputModel.Pincode" class="form-control form-control-sm" placeholder="Enter Pincode" />
                                        <span asp-validation-for="inputModel.Pincode" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>   
                    
                    </div>
                    <!-- Kerela Details Section -->

                    <!-- Emergency Contact Details Section -->
                    <div id="emergencycontactContainer" class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4 class="mb-0">
                                <i class="bi bi-person-rolodex"></i> Emergency contact
                            </h4>
                        </div>

                        <div id="Emergency_contact_form">
                            <div class="card mb-3 family-form">
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="required form-label">Name</label>
                                        <input asp-for="inputModel.EmergencyContactName" class="form-control form-control-sm" id="EmergencyContactNameInput" maxlength="100" placeholder="Enter Name" />
                                            <span asp-validation-for="inputModel.EmergencyContactName" class="text-danger"></span>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="required form-label">Relation</label>
                                            <select asp-for="inputModel.EmergencyContactRelation"
                                                    class="form-select form-select-sm"
                                                    asp-items='@new SelectList(Model.RelationTypeList, "keyID", "name")' id="RelationDDL">
                                                <option value="">Select</option>
                                            </select>
                                            <span asp-validation-for="inputModel.EmergencyContactRelation" class="text-danger"></span>
                                        </div>
                                    </div>

                                    <div class="row mb-3">

                                        <div class="col-md-6">

                                            <label class="required form-label">Mobile Number</label>

                                            <div class="input-group">
                                                <select asp-for="inputModel.EmergencyContactCountryCodeid" class="form-select form-select-sm NoDdl">
                                                    <option value="+965">+965 🇰🇼</option>
                                                    <option value="+91">+91 🇮🇳</option>
                                                </select>
                                                <input asp-for="inputModel.EmergencyContactNumber" class="form-control form-control-sm" placeholder="Enter phone number" />
                                            </div>

                                            <span id="emergencyContactNoError" class="text-danger" style="display: none;"></span>
                                            <span asp-validation-for="inputModel.EmergencyContactNumber" class="text-danger"></span>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="required form-label">Email</label>
                                            <input asp-for="inputModel.EmergencyContactEmail" class="form-control form-control-sm" id="EmailInputEmergencyContact" placeholder="Enter Email" />
                                            <span id="EmergencyContactEmailError" class="text-danger" style="display:none;"></span>
                                            <span asp-validation-for="inputModel.EmergencyContactEmail" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Emergency Contact Details Section -->

                    <br />
                    <div class="text-center">
                        <button type="submit" id="BtnSave" class="btn btn-purple px-5">Register</button>
                    </div>
                </form>
            </div>
        </div>
    </body>
</html>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.12/dist/jquery.validate.unobtrusive.min.js"></script>
<link href="~/css/select2.min.css" rel="stylesheet" />
<script src="~/js/select2.min.js"></script>

<script>
// ============================================================================
// REGISTRATION FORM - CLEAN & FIXED VERSION
// ============================================================================

$(document).ready(function () {

    // ============================================================================
    // 1. INITIALIZATION
    // ============================================================================
    initializePage();
    initializeSelect2();
    initializeValidation();
    bindEventHandlers();
    checkSuccessRedirect();
    setupEmailValidations();
    setupFamilyCivilAndPassportValidation();

    // ============================================================================
    // 2. PAGE INITIALIZATION
    // ============================================================================
    function initializePage() {
        const hiddenDob = $("#DOBInput").val();
        if (hiddenDob) {
            const parts = hiddenDob.split("-");
            if (parts.length === 3) {
                const formattedDob = `${parts[2]}-${parts[1]}-${parts[0]}`;
                $("#DOBDisplay").val(formattedDob);
            }
        }

        // Prevent form submission on Enter
        $('form input').on('keypress', function (e) {
            if (e.which === 13) {
                e.preventDefault();
                return false;
            }
        });
    }

    function initializeSelect2() {
        $('.select2').select2({ width: 'resolve' });
    }

    function checkSuccessRedirect() {
                console.log("IsSuccessReturn:");
        if ($("input[name='IsSuccessReturn']").val() === "True") {
                            console.log("IsSuccessReturn2:");
            window.location.href = "/Thankyou";
        }
    }

    // ============================================================================
    // 3. VALIDATION INITIALIZATION
    // ============================================================================
    function initializeValidation() {
        $('#ProfessionDDL').on('change', function () {
            if ($(this).val()) $('#ProfessionDDLError').text('');
        });
        $('#AreaDDL').on('change', function () {
            if ($(this).val()) $('#AreaDDLError').text('');
        });
    }

    // ============================================================================
    // 4. FORM SUBMISSION VALIDATION
    // ============================================================================
    $('form').on('submit', function (e) {
        let hasError = false;

        if ($('#ProfessionText').is(':visible') && !$('#ProfessionText').val()) {
            $('#ProfessionTextError').text('Required');
            $('#ProfessionText').addClass('is-invalid');
            hasError = true;
        } else {
            $('#ProfessionTextError').text('');
            $('#ProfessionText').removeClass('is-invalid');
        }

        if (hasError) e.preventDefault();
    });

    $('#ProfessionText').on('input', function () {
        if ($(this).val().trim() !== '') {
            $('#ProfessionTextError').text('');
            $(this).removeClass('is-invalid');
        }
    });

    // ============================================================================
    // 5. INPUT RESTRICTIONS
    // ============================================================================
    $("#NameInput, #EmergencyContactNameInput").on("input", function () {
        this.value = this.value.replace(/[^A-Za-z ]/g, '');
    });

    $("#CivilIdInput").on("input", function () {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    $("#PassportInput").on("input", function () {
        this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
    });

    $("#RelativePassportInput").on("input", function () {
        this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
    });


    $("#EmailInput, #EmailInputEmergencyContact").on("input", function () {
        this.value = this.value.replace(/[^a-zA-Z0-9@@._-]/g, '');
    });

    // ============================================================================
    // 6. CONTACT VALIDATION
    // ============================================================================
    function setupContactValidation(codeSel, inputSel, errorId) {
        const $code = $(codeSel), $input = $(inputSel), $error = $("#" + errorId);
        if (!$code.length || !$input.length) return;

        function getMaxLen() { return $code.val() === "+91" ? 10 : 8; }

        $input.on("input", function () {
            let value = $input.val().replace(/\D/g, '');
            const max = getMaxLen();
            if (value.length > max) value = value.substring(0, max);
            $input.val(value);

            if (value.length && value.length < max) {
                $error.text("Enter valid contact number").show();
            } else if (value.length === max) {
                $.get('@Url.Page("Registration", "ValidateContactNo")', { contactNo: value }, function (data) {
                    if (!data.isValid) $error.text("Contact number already exists.").show();
                    else $error.hide();
                });
            } else $error.hide();
        });

        $code.on("change", function () {
            $input.val('');
            $error.hide();
        });
    }

    setupContactValidation('[name="inputModel.CountryCodeid"]', '[name="inputModel.ContactNo"]', 'ContactNoError');
    setupContactValidation('[name="inputModel.WhatsAppNoCountryCodeid"]', '[name="inputModel.WhatsAppNo"]', 'WhatsAppNoError');
    setupContactValidation('[name="inputModel.EmergencyContactCountryCodeid"]', '[name="inputModel.EmergencyContactNumber"]', 'emergencyContactNoError');
    setupContactValidation('[name="inputModel.FamilyData[0].CountryCodeid"]', '[name="inputModel.FamilyData[0].MobileNoRelative"]', 'RelativeNoError');

    // ============================================================================
    // 7. CIVIL ID VALIDATION (MAIN)
    // ============================================================================
    $("#CivilIdInput").change(function () {
        $("#DOBDisplay, #DOBInput").val("");
        const civilId = $(this).val();
        const $error = $("#civilIdError");

        if (!/^\d+$/.test(civilId)) {
            $error.text("Only digits allowed").show();
            $(this).addClass("is-invalid");
            return;
        }

        $.get('@Url.Page("Registration", "ValidateCivilId")', { civilId: civilId }, function (data) {
            switch (data.status) {
                case 1: $error.text("Invalid Civil ID").show(); break;
                case 2: $error.text("Civil ID Already Exists").show(); break;
                case 3:
                    $error.hide(); extractDOB(civilId); break;
                default: $error.text("Unknown response").show();
            }
        });
    });

    function extractDOB(civilId) {
        if (!/^[23]\d{11}$/.test(civilId)) return;
        const dobPart = civilId.substring(1, 7);
        const yearPrefix = civilId.startsWith("2") ? "19" : "20";
        const yyyy = yearPrefix + dobPart.substring(0, 2);
        const mm = dobPart.substring(2, 4);
        const dd = dobPart.substring(4, 6);
        const formatted = `${dd}-${mm}-${yyyy}`;
        $("#DOBDisplay").val(formatted);
        $("#DOBInput").val(`${yyyy}-${mm}-${dd}`);
    }

    // ============================================================================
    // 8. PASSPORT VALIDATION (MAIN)
    // ============================================================================
    $("#PassportInput").change(function () {
        const passport = $(this).val();
        const $error = $("#PassportnoError");

        $.get('@Url.Page("Registration", "ValidatePassportNo")', { passportNo: passport }, function (data) {
            switch (data.status) {
                case 1: $error.text("Invalid Passport No").show(); break;
                case 2: $error.text("Passport No Already Exists").show(); break;
                case 3: $error.hide(); break;
                default: $error.text("Unknown response").show();
            }
        });
    });

    // ============================================================================
    // 9. EMAIL VALIDATION (ALL 3)
    // ============================================================================
    function setupEmailValidations() {
        function validateEmail(selector, errorSelector) {
            $(selector).on("input", function () {
                const val = $(this).val().trim();
                const regex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[A-Za-z]{2,}$/;
                const $error = $(errorSelector);
                if (!val) { $error.hide(); $(this).removeClass("is-invalid"); return; }
                if (!regex.test(val)) {
                    $error.text("Invalid Email").show(); $(this).addClass("is-invalid");
                } else { $error.hide(); $(this).removeClass("is-invalid"); }
            });
        }

        validateEmail('[name="inputModel.Email"]', '#EmailidError');
        validateEmail('[name="inputModel.EmergencyContactEmail"]', '#EmergencyContactEmailError');
        validateEmail('[name="inputModel.FamilyData[0].EmailRelative"]', '#EmailRelativeError');
    }

    // ============================================================================
    // 10. FAMILY SECTION TOGGLE
    // ============================================================================
    function bindEventHandlers() {
        const familySection = $('#familyDetailsContainer');
        const singleRadio = $('#membershipSingle');
        const familyRadio = $('#membershipFamily');

        //Making hidden sections not required
        function toggleFamilySection() {
            const familySection = $('#familyDetailsContainer');
            if (familyRadio.is(':checked')) {
                familySection.show();
                familySection.find("input, select, textarea").prop("disabled", false);
            } else {
                familySection.hide();
                familySection.find("input, select, textarea").prop("disabled", true);
            }
        }

        singleRadio.on('change', toggleFamilySection);
        familyRadio.on('change', toggleFamilySection);
        toggleFamilySection();
    }

    // ============================================================================
    // 11. FAMILY CIVIL ID & PASSPORT VALIDATION
    // ============================================================================
    function setupFamilyCivilAndPassportValidation() {
        $(".family-civilid").off("change").on("change", function () {
            const $input = $(this);
            const civilId = $input.val();
            const $error = $input.closest(".col-md-6").find(".civilIdErrorFamily");

            if (!/^\d+$/.test(civilId)) {
                $error.text("Only digits allowed").show();
                $input.addClass("is-invalid");
                return;
            }

            $.get('@Url.Page("Registration", "ValidateCivilId")', { civilId: civilId }, function (data) {
                switch (data.status) {
                    case 1: $error.text("Invalid Civil ID").show(); break;
                    case 2: $error.text("Civil ID Already Exists").show(); break;
                    case 3: $error.hide(); $input.removeClass("is-invalid"); break;
                }
            });
        });

        $(".family-passport").off("change").on("change", function () {
            const $input = $(this);
            const passport = $input.val();
            const $error = $input.closest(".col-md-6").find(".passportErrorFamily");

            $.get('@Url.Page("Registration", "ValidatePassportNo")', { passportNo: passport }, function (data) {
                switch (data.status) {
                    case 1: $error.text("Invalid Passport No").show(); break;
                    case 2: $error.text("Passport Already Exists").show(); break;
                    case 3: $error.hide(); $input.removeClass("is-invalid"); break;
                }
            });
        });
    }


    // ============================================================================
    // ADD ANOTHER FAMILY MEMBER - FIXED, ON TOP, VALIDATIONS WORKING
    // ============================================================================
    let familyMemberCount = 1;

    $("#addFamilyForm").on("click", function () {
        const isFamilySelected = $("#membershipFamily").is(":checked");
        if (!isFamilySelected) {
            alert("Please select 'Family' membership type first.");
            return;
        }

        $("#familyDetailsContainer").show(); // ensure section visible
        familyMemberCount++;
        const index = familyMemberCount;
        const familyFormsContainer = $("#familyForms");

        const newFamilyForm = $(`
            <div class="card mb-3 family-form" style="display:none;">
                <div class="card-body position-relative pt-10">
                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 remove-family-form">
                        <i class="fa fa-times"></i> Remove
                    </button>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Name</label>
                            <input type="text" name="inputModel.FamilyData[${index}].Name"
                                class="form-control form-control-sm family-name" placeholder="Enter family member name" required />
                        </div>
                        <div class="col-md-6">
                            <label class="required form-label">Relation</label>
                            <select name="inputModel.FamilyData[${index}].RelationType"
                                class="form-select form-select-sm" required>
                                <option value="">Select</option>
                                ${getRelationTypeOptions()}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Civil ID</label>
                            <input type="text" name="inputModel.FamilyData[${index}].CivilId"
                                class="form-control form-control-sm family-civilid" maxlength="12" placeholder="Enter Civil ID" required />
                            <span class="text-danger civilIdErrorFamily" style="display:none;"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="required form-label">Passport No</label>
                            <input type="text" name="inputModel.FamilyData[${index}].PassportNo"
                                class="form-control form-control-sm family-passport" maxlength="8" placeholder="Enter Passport No" required />
                            <span class="text-danger passportErrorFamily" style="display:none;"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Blood Group</label>
                            <select name="inputModel.FamilyData[${index}].BloodGroupid"
                                class="form-select form-select-sm" required>
                                <option value="">Select</option>
                                ${getBloodGroupOptions()}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="required form-label">Mobile Number</label>
                            <div class="input-group">
                                <select name="inputModel.FamilyData[${index}].CountryCodeid" class="form-select form-select-sm NoDdl">
                                    <option value="+965">+965 🇰🇼</option>
                                    <option value="+91">+91 🇮🇳</option>
                                </select>
                                <input type="text" name="inputModel.FamilyData[${index}].MobileNoRelative"
                                    class="form-control form-control-sm family-phone" placeholder="Enter phone number" required />
                            </div>
                            <span class="text-danger familyPhoneError" style="display:none;"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="required form-label">Email</label>
                            <input type="email" name="inputModel.FamilyData[${index}].EmailRelative"
                                class="form-control form-control-sm family-email" placeholder="Enter Email" required />
                            <span class="text-danger familyEmailError" style="display:none;"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="required form-label">Profession</label>
                            <select name="inputModel.FamilyData[${index}].Professionid"
                                class="form-select form-select-sm" required>
                                <option value="">Select</option>
                                ${getProfessionOptions()}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="required form-label">Company</label>
                            <input type="text" name="inputModel.FamilyData[${index}].CompanyName"
                                class="form-control form-control-sm" placeholder="Enter Company Name" required />
                        </div>
                    </div>
                </div>
            </div>
        `);

        // --- 🩵 1️⃣ Prepend instead of append (new on top) ---
            familyFormsContainer.append(newFamilyForm);

            // --- 🩵 2️⃣ Fade in animation for smooth view ---
            newFamilyForm.fadeIn(300);
            $('html, body').animate({ scrollTop: newFamilyForm.offset().top - 100 }, 400);

            // --- 🩵 3️⃣ Remove button ---
            newFamilyForm.find(".remove-family-form").on("click", function () {
                newFamilyForm.slideUp(300, function () {
                    $(this).remove();
                });
            });

            // --- 🩵 4️⃣ Rebind validations ---
            setupFamilyCivilAndPassportValidation();
            setupFamilyPhoneValidation(newFamilyForm);
            setupFamilyEmailValidation(newFamilyForm);
            setupPassportUppercase(newFamilyForm);

            $("form").removeData("validator").removeData("unobtrusiveValidation");
            $.validator.unobtrusive.parse("form");
        });


        // Family Phone validation (for new members)
        function setupFamilyPhoneValidation(context) {
        const $phones = context.find(".family-phone");
        $phones.off("input").on("input", function () {
            let value = $(this).val().replace(/\D/g, '');
            if (value.length > 8) value = value.substring(0, 8);
            $(this).val(value);
        });
        }

        // Family Email validation (for new members)
        function setupFamilyEmailValidation(context) {
        const $emails = context.find(".family-email");
        $emails.off("input").on("input", function () {
            const val = $(this).val().trim();
            const regex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[A-Za-z]{2,}$/;
            const $error = $(this).closest(".col-md-6").find(".familyEmailError");
            if (!val) { $error.hide(); $(this).removeClass("is-invalid"); return; }
            if (!regex.test(val)) {
                $error.text("Invalid Email").show(); $(this).addClass("is-invalid");
            } else {
                $error.hide(); $(this).removeClass("is-invalid");
            }
        });
        }

    // Family Passport Input Uppercase conversion (auto uppercase)
    function setupPassportUppercase(context) {
        const $passports = context.find(".family-passport");
        $passports.off("input").on("input", function () {
            this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        });
    }



    // ============================================================================
    // 12. REGISTER BUTTON CHECK
    // ============================================================================
    $("#BtnSave").on("click", function (e) {
        // ✅ Reindex all family member inputs before submit
        $("#familyForms .family-form").each(function (i, form) {
            $(form).find("input, select, textarea").each(function () {
                const name = $(this).attr("name");
                if (name && name.includes("inputModel.FamilyData[")) {
                    const newName = name.replace(/inputModel\.FamilyData\[\d+\]/, `inputModel.FamilyData[${i}]`);
                    $(this).attr("name", newName);
                }
            });
        });

        const form = $("form");
        const validator = form.validate();
        if (!validator.form()) {
            e.preventDefault();
            console.warn("Validation failed before submit.");
            console.log("Invalid elements:", validator.errorList.map(e => e.element.name));
        }
    });

    // ============================================================================
    // 13. Dropdown Validations
    // ============================================================================

        function getBloodGroupOptions() {
        const select = document.querySelector('[name="inputModel.BloodGroupid"]');
        if (!select) return '';
        return Array.from(select.options)
            .filter(opt => opt.value)
            .map(opt => `<option value="${opt.value}">${opt.text}</option>`)
            .join('');
    }

    function getRelationTypeOptions() {
        const select = document.getElementById('RelationDDL');
        if (!select) return '';
        return Array.from(select.options)
            .filter(opt => opt.value)
            .map(opt => `<option value="${opt.value}">${opt.text}</option>`)
            .join('');
    }

    function getProfessionOptions() {
        const select = document.getElementById('ProfessionDDL');
        if (!select) return '';
        return Array.from(select.options)
            .filter(opt => opt.value)
            .map(opt => `<option value="${opt.value}">${opt.text}</option>`)
            .join('');
    }

});
</script>
