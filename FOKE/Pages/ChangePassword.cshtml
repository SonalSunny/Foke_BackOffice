@page
@model FOKE.Pages.ChangePasswordModel
@inject ISharedLocalizer Localize
@using FOKE.Localization
@{
    Layout = "_LayoutStandaloneContent";
}

@using FOKE.Models.PageModels






@* <input type="hidden" id="hidAddVendorPageUrl" value="@Url.Content("~/CoreModule/VendorManagement/Vendor/Manage")" />



 *@

<form method="post" id="crudForm" novalidate="novalidate" autocomplete="off">
    @Html.AntiForgeryToken()


    <style>

        .text-danger {
            display: block;
            min-height: 0.75rem;
         
        }

     

        .input-with-icon {
            position: relative;
            width: 100%;
        }

        #password-field {
            padding-right: 2.5rem; /* space for eye icon */
        }

        .toggle-password {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            cursor: pointer;
            color: black; /* your preferred color */
            font-weight: bold;
        }

</style>

<div class="card">
        <div class="card-body">
            <div class="col-12" id="response">
                @if (!string.IsNullOrEmpty(Model.pageErrorMessage))
                {
                    <div class="alert alert-dismissible fade show bg-light-danger border border-light-danger shadow-lg rounded-3 p-3 w-100 d-flex flex-column align-items-center text-center" role="alert">
                        <i class="ki-duotone ki-info-circle fs-2 text-danger me-3"></i>
                        <div class="flex-grow-1 fw-bold text-dark">
                            <strong></strong> @Model.pageErrorMessage
                        </div>
                        <button type="button" class="btn-close position-absolute top-50 end-0 translate-middle-y me-3" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
            </div>
            <input type="hidden" asp-for="Input.loggedinUserId" value="@User.FindFirst("Userid")?.Value" />
        @*     <input type="hidden" asp-for="_formMode" />
            <input type="hidden" asp-for="inputModel.RoleId" />
            <input type="hidden" asp-for="inputModel.loggedinUserId" value="@User.FindFirst("Userid")?.Value" /> *@
            <div class="row">
                <div class="col-12 mb-5">
                    <div class="form-group">
                        <label class="required fs-6 fw-semibold mb-2">@Localize.Localize("Enter your current password")</label>

                        <input asp-for="Input.OldPassword" class="form-control form-control-sm old-password" placeholder="Enter current password" autocomplete="off" />

                        <span asp-validation-for="Input.OldPassword" id="oldPasswordError" class="text-danger"></span>
                        <span  class="text-danger"></span>



                    </div>
                </div>








                <div class="col-6 mb-5">
                    <div class="form-group" data-kt-password-meter="true">
                        <label class="required fs-6 fw-semibold mb-2">@Localize.Localize("Enter a new password")</label>
                        <div class="input-with-icon mb-2">
                            <input asp-for="Input.NewPassword" id="Input_NewPassword" class="form-control form-control-sm" placeholder="Enter a new password" autocomplete="new-password" type="password" />
                            <span toggle="#Input_NewPassword" class="fas fa-eye-slash toggle-password"></span>
                        </div>
                        <span asp-validation-for="Input.NewPassword" class="text-danger"></span>

                        <!-- Password strength meter -->
                                <div class="d-flex align-items-center mb-3" data-kt-password-meter-control="highlight">
                            <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                            <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                            <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                            <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px"></div>
                        </div>


                     @*    <input asp-for="Input.NewPassword" id="password-field" class="form-control form-control-sm" placeholder="Enter a new password" autocomplete="new-password" type="password" />
                     

                        <span toggle="#password-field" class="fas fa-eye toggle-password"></span>


                        <span asp-validation-for="Input.NewPassword" class="text-danger"></span> *@
                        <!-- Password strength meter -->
                @*         <div class="d-flex align-items-center mb-3" data-kt-password-meter-control="highlight">
                            <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                            <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                            <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                            <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px"></div>
                        </div> *@
                      
                     
                    </div>
                </div>
                <div class="col-6 mb-5">
                    <div class="form-group">
                        <label class="required fs-6 fw-semibold mb-2">@Localize.Localize("Confirm new password")</label>

                        <input asp-for="Input.ConfirmPassword" class="form-control form-control-sm" placeholder="Confirm new password" autocomplete="new-password" />

                        <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>

                        @*   <span class="text-danger field-validation-valid" data-valmsg-for="inputModel.Email" data-valmsg-replace="true"></span> *@

                    </div>
                </div>

    @*             <div class="card-footer text-end  fixed-bottom bg-light  ">
                 
                   <button type="button" onclick="top.hidePopup();" class="btn btn-primary btn-flat btn-sm"><i class="fas fa-times"></i>  @Localize.Localize("BTN_GO_BACK")</button> 
        

                    <button type="submit" name="btnSubmit" value="btnSave" class="btn btn-primary btn-flat btn-sm btn-req-loader"><i class="far fa-save"></i> Save</button>
                <button type="submit" name="btnSubmit" id="btnRefresh" value="btnRefresh" class="btn btn-outline-primary btn-sm d-none btn-req-loader" formnovalidate="formnovalidate">btnRefresh</button>
           
        </div> *@


                <div class="card-footer text-end fixed-bottom bg-light">
                    <div class="row">
                        <div class="col-6 text-start">
                            <button type="button" class="btn btn-secondary btn-flat btn-sm" id="btnClear"><i class="fas fa-times"></i>  @Localize.Localize("BTN_CLEAR")</button>

                        </div>
                        <div class="col-6 text-end">
                            <button type="submit" name="btnSubmit" value="btnSave" class="btn btn-primary btn-flat btn-sm btn-req-loader"><i class="far fa-save"></i> Update</button>
                            <button type="submit" name="btnSubmit" id="btnRefresh" value="btnRefresh" class="btn btn-outline-primary btn-sm d-none btn-req-loader" formnovalidate="formnovalidate">@Localize.Localize("BTN_REFRESH")</button>
                        </div>
                    </div>
                </div>
    </div>
    </div>
    </div>
</form>

@section scripts {



    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <script type="text/javascript">


                      $(document).ready(function () {

        $('#crudForm').on('submit', function (e) {
         
               if (!$(this).valid()) {
                 
                 
                   e.preventDefault(); // Prevent submission
               }
           });



            // Clear form
            $("#btnClear").click(function () {

                     $("#crudForm")[0].reset();
        $(".text-danger").text('');
        $(".input-validation-error").removeClass("input-validation-error");
        $("input").removeClass("valid").removeClass("input-validation-error");
           $("#oldPasswordError").text('');
             });


               
             
              
          

            // Show success message if any
            if ("@Model.IsSuccessReturn" === "True") {
                top.Swal.fire({
                    icon: 'success',
                    buttonsStyling: false,
                    title: "@Html.Raw(@Model.sucessMessage)",
                    showConfirmButton: false,
                    timer: 1500
                });
                top.hidePopupWithRefresh('btnRefresh');
            }

            top.hidePageLoader();

            // Validate current password with delay
            let passwordTimer;
            const delay = 500;
            var token = $('input[name="__RequestVerificationToken"]').val();

            $('.old-password').on('input', function () {
                clearTimeout(passwordTimer);
                const password = $(this).val().trim();

                if (!password) {
                    $('#oldPasswordError').text('');
                    return;
                }

                passwordTimer = setTimeout(function () {
                    $.ajax({
                        url: '@Url.Page("ChangePassword", "ValidatePassword")',
                        type: 'POST',
                        data: { oldPassword: password },
                        headers: {
                            'XSRF-TOKEN': token
                        },
                        success: function (result) {
                            if (result === true || result === "True") {
                                $('#oldPasswordError').text('');
                            } else {
                                $('#oldPasswordError').text('Current password is incorrect.');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("AJAX Error:", xhr.status, xhr.responseText);
                            $('#oldPasswordError').text('Error validating password.');
                        }
                    });
                }, delay);
            });

            // Validate New Password pattern (8-50 chars, mix of letters, numbers, symbols)
            // $('#Input_NewPassword').on('input', function () {
            //     const value = $(this).val();
              
            //     const errorSpan = $(this).next('.text-danger');
            //     const pattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z\d]).{8,50}$/;

            //     if (!pattern.test(value)) {
            //         alert('sett');
            //         this.setCustomValidity('Password must be 8-50 characters and include letters, numbers, and symbols.');
            //         errorSpan.text('Password must be 8-50 characters and include letters, numbers, and symbols.');
            //     } else {
                   
            //         this.setCustomValidity('');
            //         errorSpan.text('');
            //     }

            //     // Trigger confirm password validation if filled
            //     const confirmInput = $('#Input_ConfirmPassword');
            //     if (confirmInput.val().length > 0) {
            //         confirmInput.trigger('input');
            //     }
            // });

        //             $('#Input_NewPassword').on('input', function () {
        //     const value = $(this).val();
          
        //   // Find the closest .form-group parent, then find .text-danger inside it
        // const errorSpan = $(this).closest('.form-group').find('.text-danger').first();

        //     const pattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z\d]).{8,50}$/;

        //     if (!pattern.test(value)) {
        //         this.setCustomValidity('Password must be 8-50 characters and include letters, numbers, and symbols.');
        //         errorSpan.text('Password must be 8-50 characters and include letters, numbers, and symbols.');
        //     } else {
        //         this.setCustomValidity('');
        //         errorSpan.text('');
        //     }
        // });

            // Confirm Password match validation
            // $('#Input_ConfirmPassword').on('keyup input', function () {
            //     const newPassword = $('#Input_NewPassword').val();
            //     const confirmPassword = $(this).val();

            //     if (confirmPassword.length > 0 && confirmPassword !== newPassword) {
            //         this.setCustomValidity('Passwords do not match');
            //         $(this).next('.text-danger').text('Passwords do not match');
            //     } else {
            //         this.setCustomValidity('');
            //         $(this).next('.text-danger').text('');
            //     }
            // });
        });













    </script>


   



 
                  












     









}

