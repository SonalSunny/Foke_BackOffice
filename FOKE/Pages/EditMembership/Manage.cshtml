@page
@model FOKE.Pages.EditMembership.ManageModel
@using FOKE.Localization
@using FOKE.Models.PageModels
@inject ISharedLocalizer Localize

<form method="post" id="crudForm" novalidate="novalidate" autocomplete="off" enctype="multipart/form-data">
    <input type="hidden" id="hidManagePageUrl" value="/AllMembersList/MemberDetailsView" />
    <input type="hidden" asp-for="inputModel.IssueId" />
    @Html.AntiForgeryToken()
    <div class="card">
        <div class="card-header cursor-pointer border-bottom" role="button">
            <div class="card-title m-0">
               

                <div class="d-flex align-items-center">
                        <img id="cardProfilePreview" src="@Model.inputModel.ProfileImagePath"
                         alt="Profile Image"
                         class="rounded-circle me-3"
                         style="width: 60px; height: 60px; object-fit: cover; border: 2px solid #0d6efd;" />
                    <h3 class="fw-bold m-0">@Localize.Localize("Edit Membership Details")</h3>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div class="col-12" id="response">
                @if (!string.IsNullOrEmpty(Model.pageErrorMessage))
                {
                    <div class="alert alert-dismissible fade show bg-light-danger border border-light-danger shadow-lg rounded-3 p-3 w-100 d-flex flex-column align-items-center text-center" role="alert">
                        <i class="ki-duotone ki-info-circle fs-2 text-danger me-3"></i>
                        <div class="flex-grow-1 fw-bold text-dark">
                            <strong></strong> @Model.pageErrorMessage
                        </div>
                        <button type="button" class="btn-close position-absolute top-50 end-0 translate-middle-y me-3" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

            </div>

            <!-- Personal Information Section -->
            <div class="border rounded p-4 bg-light mb-4">
                <h5 class="fw-bold mb-4">👤@Localize.Localize("Personal Information")</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                        <label class="required fw-bold form-label-new">@Localize.Localize("Name")</label>
                        <input asp-for="inputModel.Name" class="form-control form-control-sm" id="NameInput" maxlength="100" />
                      
                        <span asp-validation-for="inputModel.Name" class="text-danger"></span>
                        </div>
                       @*  <input type="text" class="form-control form-control-sm" maxlength="100"  /> *@
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Civil ID")</label>
                            <input asp-for="inputModel.CivilId" class="form-control form-control-sm" id="CivilIdInput" maxlength="12" />

                            <span id="civilIdError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.CivilId" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Passport No")</label>
                            <input asp-for="inputModel.PassportNo" class="form-control form-control-sm" id="PassportInput" maxlength="8" />
                            <span id="PassportnoError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.PassportNo" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Date of Birth")</label>
                            <input asp-for="inputModel.DateofBirthString" class="form-control form-control-sm" id="DOBDisplay" placeholder="DD-MM-YYYY" disabled />
                            <input asp-for="inputModel.DateofBirth" type="hidden" id="DOBInput" />
                            <span asp-validation-for="inputModel.DateofBirthString" class="text-danger"></span>
                      
                        </div>
                    </div>

                    <div class="col-md-4  mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Gender")</label>
                            <select asp-for="inputModel.GenderId"
                                    class="form-select form-select-sm"
                                    asp-items='@new SelectList(Model.GenderList, "keyID", "name")'>
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.GenderId" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4  mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Blood Group")</label>
                            <select asp-for="inputModel.BloodGroupId"
                                    class="form-select form-select-sm"
                                    asp-items='@new SelectList(Model.BloodGroupList, "keyID", "name")'>
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.BloodGroupId" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                        <label class="required fw-bold form-label-new">@Localize.Localize("Contact Number")</label>
                            <div class="input-group">
                                <select asp-for="inputModel.CountryCodeId" class="form-select form-select-sm NoDdl">
                                    <option value="965">+965 🇰🇼</option>
                                    <option value="91">+91 🇮🇳</option>
                                </select>
                                <input asp-for="inputModel.ContactNo" class="form-control form-control-sm" placeholder=@Localize.Localize("Enter phone number") />
                            </div>

                            <span id="ContactNoError" class="text-danger" style="display: none;"></span>
                            <span asp-validation-for="inputModel.ContactNo" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("WhatsApp Number")</label>
                            <div class="input-group">
                                <select asp-for="inputModel.WhatsAppNoCountryCodeid" class="form-select form-select-sm NoDdl">
                                    <option value="+965">+965 🇰🇼</option>
                                    <option value="+91">+91 🇮🇳</option>
                                </select>
                                <input asp-for="inputModel.WhatsAppNo" class="form-control form-control-sm" placeholder=@Localize.Localize("Enter WhatsApp number") />
                            </div>
                            <span id="WhatsAppNoError" class="text-danger" style="display: none;"></span>
                            <span asp-validation-for="inputModel.WhatsAppNo" class="text-danger"></span>
                        </div>
                    </div>
                      
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Email")</label>
                            <input asp-for="inputModel.Email" class="form-control form-control-sm" id="EmailInput" />
                            <span asp-validation-for="inputModel.Email" class="text-danger"></span>
                        </div>
                    </div>

                   

                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Profession")</label>
                            <select asp-for="inputModel.ProfessionId"
                                    class="form-select form-select-sm select2"
                                    asp-items='@new SelectList(Model.ProfesssionList, "keyID", "name")' id="ProfessionDDL">
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.ProfessionId" class="text-danger" id="ProfessionDDLError"></span>
                        </div>
                    </div>

                    <div class="col-md-4  mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Company Name")</label>
                            <input asp-for="inputModel.Company" class="form-control form-control-sm" placeholder="Enter Company Name" />
                            <span asp-validation-for="inputModel.Company" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Area")</label>
                            <select asp-for="inputModel.AreaId"
                                    class="form-select form-select-sm select2"
                                    asp-items='@new SelectList(Model.AreaList, "keyID", "name")' id="AreaDDL">
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.AreaId" class="text-danger" id="AreaDDLError"></span>
                        </div>
                    </div>

                    <div class="col-md-12  mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Address in Kuwait")</label>
                            <textarea asp-for="inputModel.KuwaitAddress" class="form-control form-control-sm" placeholder="Enter Kuwait Address"></textarea>
                            <span asp-validation-for="inputModel.KuwaitAddress" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label class="fw-bold form-label-new">@Localize.Localize("Profile Image")</label>
                            <input asp-for="inputModel.Attachment" id="pdfUpload" type="file" class="form-control form-control-sm" accept="image/*" multiple />
                            <span asp-validation-for="inputModel.Attachment" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="border rounded p-4 mb-4 bg-light">

                <!-- Membership Type -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="required fw-bold form-label-new mb-2">Membership Type</label>
                        <div class="form-check">
                            <input type="radio" name="MembershipType" class="form-check-input" value="1" id="membershipSingle" />
                            <label class="form-check-label" for="membershipSingle">Single</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="MembershipType" class="form-check-input" value="2" id="membershipFamily" />
                            <label class="form-check-label" for="membershipFamily">Family</label>
                        </div>
                    </div>
                </div>
            </div>



            <div id="familyDetailsContainer" class="mt-2" style="display:none;">

                <div class="row">
                    <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary">
                        <i class="fa fa-users me-2"></i>Family Details
                    </h4>

                    <div class="border rounded p-4 mb-4 bg-light">

@*                         <div class="d-flex justify-content-end mb-2">
                            <button type="button" id="addFamilyForm" class="btn btn-outline-primary btn-sm ">
                                <i class="fa fa-plus me-1"></i> Add Another
                            </button>
                        </div> *@

                        <div id="familyForms">
                            <!-- First Family Member Form (index 0) -->
                            <div id="familyForms">
                                @if (Model?.inputModel?.FamilyData != null && Model.inputModel.FamilyData.Any())
                                {
                                    for (int i = 0; i < Model.inputModel.FamilyData.Count; i++)
                                    {
                                        <div class="card mb-3 family-form">
                                            <div class="card-body">
                                                <input type="hidden" name="inputModel.FamilyData[@i].IsChanged" value="false" class="is-changed-flag" />
                                                <input type="hidden" name="inputModel.FamilyData[@i].IsNew" value="false" class="is-new-flag" />
                                                <input type="hidden" name="inputModel.FamilyData[@i].MembershipId" value="@Model.inputModel.FamilyData[i].MembershipId" />


                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label class="required fw-bold form-label-new">Name</label>
                                                        <input asp-for="inputModel.FamilyData[@i].Name" class="form-control form-control-sm family-name" />
                                                        <span asp-validation-for="inputModel.FamilyData[@i].Name" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="required fw-bold form-label-new">Relation</label>
                                                        <select asp-for="inputModel.FamilyData[@i].RelationType"
                                                                class="form-select form-select-sm"
                                                                asp-items='@new SelectList(Model.RelationTypeList, "keyID", "name", Model.inputModel.FamilyData[i].RelationType)'>
                                                            <option value="">Select</option>
                                                        </select>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].RelationType" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="required fw-bold form-label-new">Civil ID</label>
                                                        <input asp-for="inputModel.FamilyData[@i].CivilId" class="form-control form-control-sm family-civilid" maxlength="12" />
                                                        <span class="text-danger civilIdErrorFamily" style="display:none;"></span>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].CivilId" class="text-danger"></span>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label class="required fw-bold form-label-new">Passport No</label>
                                                        <input asp-for="inputModel.FamilyData[@i].PassportNo" class="form-control form-control-sm family-passport" maxlength="8" />
                                                        <span class="text-danger passportErrorFamily" style="display:none;"></span>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].PassportNo" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="required fw-bold form-label-new">Blood Group</label>
                                                        <select asp-for="inputModel.FamilyData[@i].BloodGroupid"
                                                                class="form-select form-select-sm"
                                                                asp-items='@new SelectList(Model.BloodGroupList, "keyID", "name", Model.inputModel.FamilyData[i].BloodGroupid)'>
                                                            <option value="">Select</option>
                                                        </select>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].BloodGroupid" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="required fw-bold form-label-new">Mobile Number</label>
                                                        <div class="input-group">
                                                            <select asp-for="inputModel.FamilyData[@i].CountryCodeid" class="form-select form-select-sm NoDdl">
                                                                <option value="+965" selected="@(Model.inputModel.FamilyData[i].CountryCodeid == 965)">+965 🇰🇼</option>
                                                                <option value="+91" selected="@(Model.inputModel.FamilyData[i].CountryCodeid == 91)">+91 🇮🇳</option>
                                                            </select>
                                                            <input asp-for="inputModel.FamilyData[@i].MobileNoRelative" class="form-control form-control-sm family-mobile" />
                                                        </div>
                                                        <span id="RelativeNoError_@i" class="text-danger" style="display: none;"></span>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].MobileNoRelative" class="text-danger"></span>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label class="required fw-bold form-label-new">Email</label>
                                                        <input asp-for="inputModel.FamilyData[@i].EmailRelative" class="form-control form-control-sm family-email" />
                                                        <span id="EmailRelativeError_@i" class="text-danger" style="display:none;"></span>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].EmailRelative" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="fw-bold form-label-new">Profession (Optional)</label>
                                                        <select asp-for="inputModel.FamilyData[@i].Professionid"
                                                                class="form-select form-select-sm family-profession"
                                                                asp-items='@new SelectList(Model.ProfesssionList, "keyID", "name", Model.inputModel.FamilyData[i].Professionid)'>
                                                            <option value="">Select</option>
                                                        </select>
                                                        <span asp-validation-for="inputModel.FamilyData[@i].Professionid" class="text-danger"></span>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label class="fw-bold form-label-new">Company (Optional)</label>
                                                        <input asp-for="inputModel.FamilyData[@i].CompanyName" class="form-control form-control-sm family-company" />
                                                        <span asp-validation-for="inputModel.FamilyData[@i].CompanyName" class="text-danger"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <!-- If no existing family, show one empty form -->
                                    <div class="card mb-3 family-form">
                                        <div class="card-body">

                                            <input type="hidden" name="inputModel.FamilyData[0].IsChanged" value="true" class="is-changed-flag" />
                                            <input type="hidden" name="inputModel.FamilyData[0].IsNew" value="true" class="is-new-flag" />

                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="required fw-bold form-label-new">Name</label>
                                                    <input asp-for="inputModel.FamilyData[0].Name" class="form-control form-control-sm family-name" placeholder="Enter family member name" />
                                                    <span asp-validation-for="inputModel.FamilyData[0].Name" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="required fw-bold form-label-new">Relation</label>
                                                    <select asp-for="inputModel.FamilyData[0].RelationType"
                                                            class="form-select form-select-sm"
                                                            asp-items='@new SelectList(Model.RelationTypeList, "keyID", "name")' id="RelationDDL">
                                                        <option value="">Select</option>
                                                    </select>
                                                    <span asp-validation-for="inputModel.FamilyData[0].RelationType" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="required fw-bold form-label-new">Civil ID</label>
                                                    <input asp-for="inputModel.FamilyData[0].CivilId" class="form-control form-control-sm family-civilid" maxlength="12" placeholder="Enter Civil ID" />
                                                    <span class="text-danger civilIdErrorFamily" style="display:none;"></span>
                                                    <span asp-validation-for="inputModel.FamilyData[0].CivilId" class="text-danger"></span>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="required fw-bold form-label-new">Passport No</label>
                                                    <input asp-for="inputModel.FamilyData[0].PassportNo" class="form-control form-control-sm family-passport" maxlength="8" placeholder="Enter Passport No" />
                                                    <span class="text-danger passportErrorFamily" style="display:none;"></span>
                                                    <span asp-validation-for="inputModel.FamilyData[0].PassportNo" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="required fw-bold form-label-new">Blood Group</label>
                                                    <select asp-for="inputModel.FamilyData[0].BloodGroupid"
                                                            class="form-select form-select-sm"
                                                            asp-items='@new SelectList(Model.BloodGroupList, "keyID", "name")' id="BloodGroupDDL">
                                                        <option value="">Select</option>
                                                    </select>
                                                    <span asp-validation-for="inputModel.FamilyData[0].BloodGroupid" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="required fw-bold form-label-new">Mobile Number</label>
                                                    <div class="input-group">
                                                        <select asp-for="inputModel.FamilyData[0].CountryCodeid" class="form-select form-select-sm NoDdl" id="FamilyCountryDDL">
                                                            <option value="+965">+965 🇰🇼</option>
                                                            <option value="+91">+91 🇮🇳</option>
                                                        </select>
                                                        <input asp-for="inputModel.FamilyData[0].MobileNoRelative" class="form-control form-control-sm family-mobile" placeholder="Enter phone number" />
                                                    </div>
                                                    <span id="RelativeNoError" class="text-danger" style="display: none;"></span>
                                                    <span asp-validation-for="inputModel.FamilyData[0].MobileNoRelative" class="text-danger"></span>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="required fw-bold form-label-new">Email</label>
                                                    <input asp-for="inputModel.FamilyData[0].EmailRelative" class="form-control form-control-sm family-email" placeholder="Enter Email" />
                                                    <span id="EmailRelativeError" class="text-danger" style="display:none;"></span>
                                                    <span asp-validation-for="inputModel.FamilyData[0].EmailRelative" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="fw-bold form-label-new">Profession (Optional)</label>
                                                    <select asp-for="inputModel.FamilyData[0].Professionid"
                                                            class="form-select form-select-sm family-profession"
                                                            asp-items='@new SelectList(Model.ProfesssionList, "keyID", "name")' id="ProfessionDDL_Family">
                                                        <option value="">Select</option>
                                                    </select>
                                                    <span asp-validation-for="inputModel.FamilyData[0].Professionid" class="text-danger"></span>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="fw-bold form-label-new">Company (Optional)</label>
                                                    <input asp-for="inputModel.FamilyData[0].CompanyName" class="form-control form-control-sm family-company" placeholder="Enter Company Name" />
                                                    <span asp-validation-for="inputModel.FamilyData[0].CompanyName" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary">
                <i class="fa fa-home me-2"></i>Kerela Details
            </h4>

            <div class="border rounded p-4 mb-4 bg-light mb-4">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label class="required form-label"> Permenant Address</label>
                            <textarea asp-for="inputModel.PermenantAddress" class="form-control form-control-sm" placeholder="Enter Permenant Address"></textarea>
                            <span asp-validation-for="inputModel.PermenantAddress" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Pincode")</label>
                            <input asp-for="inputModel.Pincode" class="form-control form-control-sm" placeholder="Enter Pincode" />
                            <span asp-validation-for="inputModel.Pincode" class="text-danger"></span>
                        </div>
                    </div>

                </div>
            </div>

            <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary">
                <i class="bi bi-person-rolodex"></i> Emergency contact Details
            </h4>

            <div class="border rounded p-4 bg-light mb-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Name")</label>
                            <input asp-for="inputModel.EmergencyContactName" class="form-control form-control-sm" id="EmergencyContactNameInput" maxlength="100" placeholder="Enter Name" />
                            <span asp-validation-for="inputModel.EmergencyContactName" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Relation")</label>
                            <select asp-for="inputModel.EmergencyContactRelation"
                                    class="form-select form-select-sm"
                                    asp-items='@new SelectList(Model.RelationTypeList, "keyID", "name")' id="RelationDDL">
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="inputModel.EmergencyContactRelation" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Mobile Number")</label>
                            <div class="input-group">
                                <select asp-for="inputModel.EmergencyContactCountryCodeid" class="form-select form-select-sm NoDdl">
                                    <option value="+965">+965 🇰🇼</option>
                                    <option value="+91">+91 🇮🇳</option>
                                </select>
                                <input asp-for="inputModel.EmergencyContactNumber" class="form-control form-control-sm" placeholder="Enter phone number" />
                            </div>

                            <span id="emergencyContactNoError" class="text-danger" style="display: none;"></span>
                            <span asp-validation-for="inputModel.EmergencyContactNumber" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label class="required fw-bold form-label-new">@Localize.Localize("Email")</label>
                            <input asp-for="inputModel.EmergencyContactEmail" class="form-control form-control-sm" id="EmailInputEmergencyContact" placeholder="Enter Email" />
                            <span id="EmergencyContactEmailError" class="text-danger" style="display:none;"></span>
                            <span asp-validation-for="inputModel.EmergencyContactEmail" class="text-danger"></span>
                        </div>
                    </div>

                </div>
            </div>

            <div class="border rounded p-4 bg-light mb-4">
                <h5 class="fw-bold mb-4">👤@Localize.Localize("For Office Use Only")</h5>
                <div class="row">
                    <!-- Referred By Search Group (now more compact) -->
                    <div class="col-md-6 mb-3">
                       
                        <div class="form-group">
                            <label class="fw-bold form-label-new">@Localize.Localize("Referred By")</label>
                            <div class="input-group">
                                <select asp-for="inputModel.SearchText" id="searchColumn" class="form-select form-select-sm"
                                        asp-items='@new SelectList(Model.pageListFilterColumns, "ColumName", "ColumnDescription")'>
                                </select>
                                <input type="text" id="referredByInput" value="@Model.inputModel.ReferredByName" class="form-control form-control-sm" placeholder=@Localize.Localize("Referred By") />
                                <input asp-for="inputModel.ReferredBy" type="hidden" id="SelectedMemberIdss" />
                            </div>
                            <span asp-validation-for="inputModel.ReferredBy" class="text-danger"></span>

                            <!-- ✅ Add result container here -->
                            <div id="resultsContainer1" class="mt-2"></div>

                            <!-- Hidden field to store selected ID -->
                            <input type="hidden" id="SelectedMemberIdss" name="SelectedMemberIdss" />
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="required fw-bold form-label-new">@Localize.Localize("Zone")</label>
                        <select asp-for="inputModel.ZoneId" id="ZoneId"
                                class="form-select form-select-sm select2"
                                asp-items='@new SelectList(Model.ZoneList, "keyID", "name")'>
                            <option value="">Select</option>
                        </select>
                        <span asp-validation-for="inputModel.ZoneId" class="text-danger" id="ZoneDDLError"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="required fw-bold form-label-new">@Localize.Localize("Unit")</label>
                        <select asp-for="inputModel.UnitId" id="UnitId"
                                class="form-select form-select-sm select2"
                                asp-items='@new SelectList(Model.UnitList, "keyID", "name")'>
                            <option value="">Select</option>
                        </select>
                        <span asp-validation-for="inputModel.UnitId" class="text-danger" id="UnitDDLError"></span>
                    </div>

                    <div class="col-md-6  mb-3">
                        <div class="form-group">
                            <label class="required form-label-new">@Localize.Localize("Membership No")</label>
                            <input asp-for="inputModel.MembershipNo" class="form-control form-control-sm" placeholder="Enter Membership No" />
                            <span asp-validation-for="inputModel.MembershipNo" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Submit Button (Optional Static Button) -->
            <div class="text-end">
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</form>

<link href="~/css/select2.min.css" rel="stylesheet" />
<script src="~/js/jquery-3.6.0.min.js"></script>
<script src="~/js/select2.min.js"></script>
@section scripts {
    <partial name="_ValidationScriptsPartial" />

    <script type="text/javascript">
        $(document).ready(function () {


                    $("#crudForm").on("submit", function (e) {
            let hasErrors = false;

         
            $(".text-danger:visible").each(function () {
                if ($(this).text().trim() !== "") {
                    hasErrors = true;
                    return false; 
                }
            });

           
            if ($(".is-invalid").length > 0) {
                hasErrors = true;
            }

            if (hasErrors) {
                e.preventDefault();
        //                 top.Swal.fire({
        //     icon: "warning",
        //     title: "Please review the form",
        //     text: "Some fields need your attention. Kindly fix the highlighted errors before submitting.",
        //     confirmButtonText: "OK",
        //     buttonsStyling: false
        // });

                top.Swal.fire({
                    icon: "error",
                    title: "Please review the form",
                    text: "Kindly fix the highlighted errors before submitting."
                });
            }
        });

            $('#crudForm input').on('keypress', function (e) {
                if (e.which === 13) { // Enter key code
                    e.preventDefault();
                    return false;
                }
            });

            $('.select2').select2();

            console.log("Select2 initialized");
              if ("@Model.IsSuccessReturn" == "True") {
            top.Swal.fire({
                   icon: 'success',
                   buttonsStyling: false,
                   title: "@Html.Raw(@Model.sucessMessage)",
                   showConfirmButton: false,
                   timer: 1500
            })

            setTimeout(function () {
                      window.location.href = '/EditMembership/MemberSearchForm';  // Redirect to Index page after 1.5 seconds
            }, 1500);
        }

          $('#WorkPlaceDDL').on('change', function () {
              var selectedValue = $(this).val();
              if (selectedValue) {
                  $('#WorkPlaceError').text(''); // Clear validation message
              }
            });
            $('#ProfessionDDL').on('change', function () {
                var selectedValue1 = $(this).val();
                  if (selectedValue1) {
                      $('#ProfessionDDLError').text(''); // Clear validation message
                }
             });
             $('#DistrictDDl').on('change', function () {
                  var selectedValue1 = $(this).val();
                    if (selectedValue1) {
                          $('#DistrictDDlError').text(''); // Clear validation message
                  }
             });
             $('#WorkYearDDl').on('change', function () {
                    var selectedValue1 = $(this).val();
                      if (selectedValue1) {
                              $('#WorkYearDDlError').text(''); // Clear validation message
                    }
             });
             $('#DepartmentDDL').on('change', function () {
                      var selectedValue1 = $(this).val();
                        if (selectedValue1) {
                                  $('#DepartmentDDLError').text(''); // Clear validation message
                      }
             });
             $('#AreaDDL').on('change', function () {
                        var selectedValue1 = $(this).val();
                          if (selectedValue1) {
                                      $('#AreaDDLError').text(''); // Clear validation message
                        }
             });
              $('#HearAboutDDL').on('change', function () {
                        var selectedValue1 = $(this).val();
                          if (selectedValue1) {
                              $('#HearAboutDDLError').text(''); // Clear validation message
                        }
             });
             $('#ZoneId').on('change', function () {
                        var selectedValue1 = $(this).val();
                          if (selectedValue1) {
                                      $('#ZoneDDLError').text(''); // Clear validation message
                        }
             });

             $('#UnitId').on('change', function () {
                        var selectedValue1 = $(this).val();
                          if (selectedValue1) {
                                      $('#UnitDDLError').text(''); // Clear validation message
                        }
             });

      
        $("#btnClear").click(function () {
                      $("#crudForm")[0].reset();
                  });

                  top.hidePageLoader();

                  $.validator.unobtrusive.parse("#crudForm");
                  $('.role-code').change(function () {
                      var selectedValue = $(this).val();
                      $("#btnRefresh").click();
                  });

        });


         document.addEventListener("DOMContentLoaded", function () {
            const countryCodeSelect = document.querySelector('[name="inputModel.CountryCodeId"]');
            const contactInput = document.querySelector('[name="inputModel.ContactNo"]');
            const errorSpan = document.getElementById("ContactNoError");

            function getMaxLength() {
                return countryCodeSelect.value === "91" ? 10 : 8;
            }

            function isDigitsOnly(value) {
                return /^\d*$/.test(value);
            }

            function validateAndCheck() {
                let value = contactInput.value.replace(/\D/g, '');
                const maxLength = getMaxLength();

                // Trim and enforce digit-only
                if (!isDigitsOnly(value)) {
                    value = value.replace(/\D/g, '');
                }
                if (value.length > maxLength) {
                    value = value.substring(0, maxLength);
                }

                if (value.length < maxLength) {
                    errorSpan.textContent = "Enter a valid contact number.";
                    errorSpan.style.display = "block";
                    return; // Stop further validation
                }

                contactInput.value = value;

                if (value.length === maxLength) {
                    // Valid length reached → check with backend
                    $.ajax({
                        url: '@Url.Page("Manage", "ValidateContactNo")',
                        type: 'GET',
                        data: { contactNo: value,
                          issueId: '@Model.inputModel.IssueId'},
                        success: function (data) {
                            if (!data.isValid) {
                                errorSpan.textContent = "Contact number already exists.";
                                errorSpan.style.display = "block";
                            } else {
                                errorSpan.textContent = "";
                                errorSpan.style.display = "none";
                            }
                        },
                        error: function () {
                            console.log("AJAX call failed.");
                        }
                    });
                } else {
                    // Not enough digits yet → don't check
                    errorSpan.textContent = "";
                    errorSpan.style.display = "none";
                }
            }

            contactInput.addEventListener("input", validateAndCheck);
            countryCodeSelect.addEventListener("change", function () {
                contactInput.value = ""; // reset input
                validateAndCheck();      // recalculate length and error state
            });
        });


        document.addEventListener("DOMContentLoaded", function () {
                const nameInput = document.getElementById("NameInput");

                nameInput.addEventListener("input", function () {
                    // Replace anything that's not a letter or space
                    this.value = this.value.replace(/[^A-Za-z ]/g, '');
                });
        });

        document.addEventListener("DOMContentLoaded", function () {
            const civilIdInput = document.getElementById("CivilIdInput");

            civilIdInput.addEventListener("input", function () {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
                $("#CivilIdInput").on("input", function () {
          //  $("#CivilIdInput").change(function () {
                var civilId = $(this).val();

                if (!/^\d+$/.test(civilId)) {
                    $("#civilIdError").text("Only digits are allowed.").show();
                    $(this).addClass("is-invalid");
                    return;
                } else {
                    $("#civilIdError").text("").hide();
                    $(this).removeClass("is-invalid");
                }

                if (civilId) {
                    $.ajax({
                        url: '@Url.Page("Manage", "ValidateCivilId")',
                        type: 'GET',
                        data: { civilId: civilId,
                          issueId: '@Model.inputModel.IssueId' },
                        success: function (data) {
                            console.log(data);

                            switch (data.status) {
                                case 1:
                                    $("#civilIdError").text("Invalid Civil ID").show();
                                    $("#CivilIdInput").addClass("is-invalid");
                                    document.getElementById("DOBDisplay").value = "";
                                    break;

                                case 2:
                                    $("#civilIdError").text("Civil ID Already Exists").show();
                                    $("#CivilIdInput").addClass("is-invalid");
                                    document.getElementById("DOBDisplay").value = "";
                                    break;

                                case 3:
                                    $("#civilIdError").text("").hide();
                                    $("#CivilIdInput").removeClass("is-invalid");
                                     Extractdbo(civilId);
                                    break;
                                  

                                default:
                                    $("#civilIdError").text("Unknown validation response").show();
                                    $("#CivilIdInput").addClass("is-invalid");
                                    document.getElementById("DOBDisplay").value = "";
                                    break;
                            }
                        },
                        error: function () {
                            $("#civilIdError").text("Error Validating Civil ID").show();
                            $("#CivilIdInput").addClass("is-invalid");
                        }
                    });
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            const PassportInput = document.getElementById("PassportInput");

            PassportInput.addEventListener("input", function () {
                this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase(); // Auto-uppercase
            });

           $("#PassportInput").change(function () {
                var passportNumber = $(this).val();

                if (passportNumber) {
                console.log(passportNumber);
                $.ajax({
                    url: '@Url.Page("Manage", "ValidatePassportNo")',
                    type: 'GET',
                    data: { passportNo : passportNumber,
                      issueId: '@Model.inputModel.IssueId'},
                    success: function (data) {
                        switch (data.status) {
                                case 1:
                                    $("#PassportnoError").text("Invalid Passport No").show();
                                    break;

                                case 2:
                                    $("#PassportnoError").text("PassportNo Already Exists").show();
                                    break;

                                case 3:
                                    $("#PassportnoError").text("").hide();
                                    break;

                                default:
                                    $("#PassportnoError").text("Unknown validation response").show();
                                    break;
                            }
                        }
                    });
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            const EmailInput = document.getElementById("EmailInput");

            EmailInput.addEventListener("input", function () {
                this.value = this.value.replace(/[^a-zA-Z0-9@@._-]/g, '');
            });
            EmailInput.addEventListener("change", function () {
                const email = this.value;
                const regex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\..+$/;
                if (!regex.test(email)) {
                    $("#EmailidError").text("Invalid Emailid").show();
                    $(this).addClass("is-invalid");
                    return;
                }
                else {
                    $("#EmailidError").text("").hide();
                    $(this).removeClass("is-invalid");
                }
            });

        });

        function Extractdbo(civilId) {
          
            if (!/^[23]\d{11}$/.test(civilId)) return;

            const dobPart = civilId.substring(1, 7); // YYMMDD
            const yearPrefix = civilId.startsWith("2") ? "19" : "20";
            const fullDateStr = yearPrefix + dobPart; // e.g. 19850715

            const yyyy = fullDateStr.substring(0, 4);
            const mm = fullDateStr.substring(4, 6);
            const dd = fullDateStr.substring(6, 8);
            const formattedDate = ` ${dd}-${mm}-${yyyy}`;

           // // document.getElementById("DOBDisplay").value = formattedDate;
            //// document.getElementById("DOBInput").value = `${yyyy}-${mm}-${dd}`;
                  const isoDate = `${yyyy}-${mm}-${dd}`;

        // Set values
        const displayField = document.getElementById("DOBDisplay");
      
        const hiddenDob = document.getElementById("DOBInput");
       
        if (displayField) displayField.value = formattedDate;
        if (hiddenDob) hiddenDob.value = isoDate;



        }


        document.addEventListener("DOMContentLoaded", function () {
            const civilIdInput = document.getElementById("CivilIdInput");
        });

         function fetchAndShowResults() {
            let keyword = $('#referredByInput').val().trim();
            let selectedColumn = $('#searchColumn').val();
            console.log(selectedColumn);
            if (!keyword) return;

            $.ajax({
                url: '@Url.Page("Manage", "GetDetails")',
                type: 'GET',
                data: {
                    keyword: keyword,
                    searchText: selectedColumn
                },
                success: function (response) {
                    if (response && response.returnData && response.returnData.length > 0) {
                        const members = response.returnData;

                        let table = `
                        <table class="table table-bordered table-hover table-sm">
                            <thead class="table-light">
                            <tr>
                                <th>Membership ID</th>
                                <th>Full Name</th>
                                <th>Civil ID</th>
                                <th>Phone Number</th>
                            </tr>
                            </thead>
                        <tbody>
                        `;

                        members.forEach(member => {
                            table += `
                                <tr class="select-member" data-id="${member.issueId}" data-name="${member.name}" style="cursor:pointer;">
                                    <td>${member.referenceNumber || ''}</td>
                                    <td>${member.name}</td>
                                    <td>${member.civilId || ''}</td>
                                    <td>${member.contactNo || ''}</td>
                                </tr>
                            `;
                        });

                        table += '</tbody></table>';
                        document.getElementById('resultsContainer1').innerHTML = table;
                    } else {
                        document.getElementById('resultsContainer1').innerHTML = `<p class="text-danger">No results found.</p>`;
                    }
                }, 
                error: function () {
                    alert("An error occurred while fetching the member data.");
                }
            });
        }

        $('#referredByInput').on('blur', function () {
            setTimeout(() => {
            fetchAndShowResults();
            }, 200); // Delay allows row click to register
        });

        // Trigger search on Enter key
        $('#referredByInput').on('keypress', function (e) {
            if (e.which === 13) {
            e.preventDefault();
            fetchAndShowResults();
            }
        });

        // Handle selection of member from results
        $(document).on('click', '.select-member', function () {
            const name = $(this).data('name');
            const id = $(this).data('id');

            $('#referredByInput').val(name);
            $('#SelectedMemberIdss').val(id);

                // Replace the results container with the selected member only
        $('#resultsContainer1').html(`
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Membership ID</th>
                        <th>Full Name</th>
                        <th>Civil ID</th>
                        <th>Phone Number</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="Unselect-member">
                        <td>${$(this).closest('tr').find('td:eq(0)').text()}</td>
                        <td>${name}</td>
                        <td>${$(this).closest('tr').find('td:eq(2)').text()}</td>
                        <td>${$(this).closest('tr').find('td:eq(3)').text()}</td>
                    </tr>
                </tbody>
            </table>
        `);
        });
         $(document).on('click', '.Unselect-member', function () {

         fetchAndShowResults();
         });

            
        document.getElementById('pdfUpload')?.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const previewImg = document.getElementById('cardProfilePreview');
                    if (previewImg) {
                        previewImg.src = e.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }
        });


               // ============================================================
        // FAMILY SECTION - TOGGLE + ADD/EDIT HANDLING
        // ============================================================
        $(document).ready(function () {
            initMembershipToggle();
            initAddFamilyMember();
            setupFamilyChangeTracking();
        });

        // Toggle visibility of Family Section
        function initMembershipToggle() {
            const existingFamilyCount = @((Model?.inputModel?.FamilyData?.Count ?? 0));
            const familyContainer = document.getElementById('familyDetailsContainer');
            const singleRadio = document.getElementById('membershipSingle');
            const familyRadio = document.getElementById('membershipFamily');
            if (!familyContainer) return;

            // ✅ Auto-check based on existing data
            if (existingFamilyCount > 0) {
                familyRadio.checked = true;
                familyContainer.style.display = 'block';
            } else {
                singleRadio.checked = true;
                familyContainer.style.display = 'none';
            }

            // ✅ Add event listeners for manual toggle
            const toggle = () => {
                familyContainer.style.display = familyRadio.checked ? 'block' : 'none';
            };
            singleRadio.addEventListener('change', toggle);
            familyRadio.addEventListener('change', toggle);
        }

        // ============================================================
        // ADD NEW FAMILY MEMBER DYNAMICALLY
        // ============================================================
        function initAddFamilyMember() {
            let familyMemberCount = @((Model?.inputModel?.FamilyData?.Count ?? 1));
            const addBtn = document.getElementById('addFamilyForm');
            const container = document.getElementById('familyForms');
            if (!addBtn || !container) return;

            addBtn.addEventListener('click', function () {
                const index = familyMemberCount++;
                const newCard = document.createElement('div');
                newCard.className = 'card mb-3 family-form';
                newCard.innerHTML = `
                    <div class="card-body position-relative pt-10">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 remove-family-form">
                            <i class="fa fa-times"></i> Remove
                        </button>

                        <input type="hidden" name="inputModel.FamilyData[${index}].IsChanged" value="true" class="is-changed-flag" />
                        <input type="hidden" name="inputModel.FamilyData[${index}].IsNew" value="true" class="is-new-flag" />

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="required fw-bold form-label-new">Name</label>
                                <input type="text" name="inputModel.FamilyData[${index}].Name" class="form-control form-control-sm family-name" placeholder="Enter family member name" />
                            </div>

                            <div class="col-md-4">
                                <label class="required fw-bold form-label-new">Relation</label>
                                <select name="inputModel.FamilyData[${index}].RelationType" class="form-select form-select-sm">
                                    ${getRelationTypeOptions()}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="required fw-bold form-label-new">Civil ID</label>
                                <input type="text" name="inputModel.FamilyData[${index}].CivilId" class="form-control form-control-sm family-civilid" maxlength="12" />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="required fw-bold form-label-new">Passport No</label>
                                <input type="text" name="inputModel.FamilyData[${index}].PassportNo" class="form-control form-control-sm family-passport" maxlength="8" />
                            </div>

                            <div class="col-md-4">
                                <label class="required fw-bold form-label-new">Blood Group</label>
                                <select name="inputModel.FamilyData[${index}].BloodGroupid" class="form-select form-select-sm">
                                    ${getBloodGroupOptions()}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="required fw-bold form-label-new">Mobile Number</label>
                                <div class="input-group">
                                    <select name="inputModel.FamilyData[${index}].CountryCodeid" class="form-select form-select-sm NoDdl">
                                        <option value="+965">+965 🇰🇼</option>
                                        <option value="+91">+91 🇮🇳</option>
                                    </select>
                                    <input type="text" name="inputModel.FamilyData[${index}].MobileNoRelative" class="form-control form-control-sm family-mobile" />
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="required fw-bold form-label-new">Email</label>
                                <input type="email" name="inputModel.FamilyData[${index}].EmailRelative" class="form-control form-control-sm family-email" />
                            </div>

                            <div class="col-md-4">
                                <label class="fw-bold form-label-new">Profession (Optional)</label>
                                <select name="inputModel.FamilyData[${index}].Professionid" class="form-select form-select-sm">
                                    ${getProfessionOptions()}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="fw-bold form-label-new">Company (Optional)</label>
                                <input type="text" name="inputModel.FamilyData[${index}].CompanyName" class="form-control form-control-sm family-company" />
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(newCard);
                $(newCard).find('.remove-family-form').on('click', () => newCard.remove());
                bindFamilyInputMasks(newCard);
            });

            bindFamilyInputMasks(container);
        }

        // ============================================================
        // SUPPORT FUNCTIONS FOR OPTIONS AND VALIDATIONS
        // ============================================================
        function getRelationTypeOptions() {
            const select = document.getElementById('RelationDDL');
            if (!select) return '';
            return Array.from(select.options).filter(o => o.value)
                .map(o => `<option value="${o.value}">${o.text}</option>`).join('');
        }

        function getBloodGroupOptions() {
            const select = document.getElementById('BloodGroupDDL');
            if (!select) return '';
            return Array.from(select.options).filter(o => o.value)
                .map(o => `<option value="${o.value}">${o.text}</option>`).join('');
        }

        function getProfessionOptions() {
            const select = document.getElementById('ProfessionDDL_Family');
            if (!select) return '';
            return Array.from(select.options).filter(o => o.value)
                .map(o => `<option value="${o.value}">${o.text}</option>`).join('');
        }

        // ============================================================
        // SIMPLE INPUT MASKS / VALIDATION FOR FAMILY MEMBERS
        // ============================================================
        function bindFamilyInputMasks(scopeEl) {
            $(scopeEl).find('.family-name').on('input', function () {
                this.value = this.value.replace(/[^A-Za-z ]/g, '');
            });

            $(scopeEl).find('.family-civilid').on('input', function () {
                this.value = this.value.replace(/[^0-9]/g, '');
            });

            $(scopeEl).find('.family-passport').on('input', function () {
                this.value = this.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
            });

            $(scopeEl).find('.family-email').on('change', function () {
                const ok = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-z]{2,}$/.test(this.value);
                this.classList.toggle('is-invalid', !ok);
            });
        }

        // ============================================================
        // CHANGE TRACKING FOR EXISTING FAMILY DATA
        // ============================================================
        function setupFamilyChangeTracking() {
            const familyContainer = document.getElementById('familyForms');
            if (!familyContainer) return;

            $(familyContainer).on('input change', '.family-form input, .family-form select', function () {
                const card = $(this).closest('.family-form');
                const isNewFlag = card.find('.is-new-flag').val() === 'true';
                const isChangedInput = card.find('.is-changed-flag');

                // ✅ Mark as changed only if not new
                if (!isNewFlag) {
                    isChangedInput.val('true');
                }
            });
        }
    </script>
}
