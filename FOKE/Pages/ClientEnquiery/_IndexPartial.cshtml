@model IndexModel
@using X.PagedList;
@using X.PagedList.Mvc.Core;
@using FOKE.Localization
@using FOKE.Models.PageModels
@inject ISharedLocalizer Localize
<div class="table-responsive ">
    <input type="hidden" asp-for="pageNo" id="hidpageNo" />
    <input type="hidden" asp-for="pageSize" id="hidpageSize" />
    <input type="hidden" asp-for="sortColumn" id="hidSortColumn" />
    <input type="hidden" asp-for="sortOrder" id="hidSortOrder" />
    <table class="table table-hover table-rounded table-striped border gy-4 gs-7 table-sortable table-scroll">
        <thead>
            <tr>
                <th class="sorting t-plr-sm-5">  @Localize.Localize("TABLE_ACTION_HEADER")</th>

                <th class="sorting t-plr-sm-5" area-field="MemberName">
                    @Localize.Localize("MEMBER_NAME")
                    <span><i class="fas fa-sort text-white" aria-hidden="true"></i></span>
                </th>
                <th class="sorting t-plr-sm-5" area-field="MemberName">
                    @Localize.Localize("Issue_Type")
                    <span><i class="fas fa-sort text-white" aria-hidden="true"></i></span>
                </th>
                <th class="sorting t-plr-sm-5" area-field="Description">
                    @Localize.Localize("ISSUE_DESCRIPTION")
                    <span><i class="fas fa-sort text-white" aria-hidden="true"></i></span>
                </th>
                <th class="sorting t-plr-sm-5" area-field="ContactNo">
                    @Localize.Localize("CONTACT_NO")
                    <span><i class="fas fa-sort text-white" aria-hidden="true"></i></span>
                </th>
                <th class="sorting t-plr-sm-5" area-field="ContactNo">
                    @Localize.Localize("RECIEVED_DATE")
                    <span><i class="fas fa-sort text-white" aria-hidden="true"></i></span>
                </th>
                <th class="sorting t-plr-sm-5" area-field="ContactNo">
                    @Localize.Localize("RESOLVED_BY")
                    <span><i class="fas fa-sort text-white" aria-hidden="true"></i></span>
                </th>
                <th class="sorting t-plr-sm-5" area-field="ContactNo">
                    @Localize.Localize("RESOLVED_DATE")
                    <span><i class="fas fa-sort text-white" aria-hidden="true"></i></span>
                </th>
                <th class="sorting t-plr-sm-5" area-field="Status">
                    @Localize.Localize("STATUS")
                    <span><i class="fas fa-sort text-white" aria-hidden="true"></i></span>
                </th>
            </tr>
        </thead>
        <tbody>
            @if (Model.pagedListData != null && Model.pagedListData.Count() > 0)
            {
                @for (int i = 0; i < Model.pagedListData.Count(); i++)
                {
                    var item = Model.pagedListData[i];
                    <tr>
                        <td>
                            <!-- Replace "Actions" button with a 3-dots horizontal icon -->
                            <div class="test btn btn-icon btn-sm btn-light btn-center btn-active-light-primary"
                                 data-kt-menu-trigger="click"
                                 data-kt-menu-placement="bottom-end">
                            </div>

                            <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4"
                                 data-kt-menu="true">
                                @if (item.Active)
                                {
                                    <div class="menu-item px-3">
                                        <a href="#" class="text-muted menu-link px-3 btnResolveItem"
                                           keyID="@item.Id"
                                           title="Resolve Issue"
                                           data-kt-customer-table-filter="resolve_row">
                                            Resolve
                                        </a>
                                    </div>
                                }
                            </div>
                        </td>
                        <td>
                            @item.Name
                        </td>
                        <td>
                            @item.Type
                        </td>
                        <td>
                            @item.Description
                        </td>
                        <td>
                            @item.ContactNo
                        </td>
                        <td>
                            @item.DateOfCreation
                        </td>
                        <td>
                            @item.ResolvedBy
                        </td>
                        <td>
                            @item.ResolvedDate
                        </td>
                        <td>
                            @if (item.IsResolved)
                            {
                                <span class="badge badge-success">Resolved</span>
                            }
                            else
                            {
                                <span class="badge badge-danger">Pending</span>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>
<div class="row">
    <div class="col-sm-12 col-md-5 d-flex align-items-center justify-content-center justify-content-md-start pt-3">
        <div class="dataTables_length" id="kt_datatable_fixed_header_length">
            <label>
                <select asp-for="pageSize" id="kt_datatable_page_size" class="form-select form-select-sm form-select-solid">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </label>
        </div><div class="dataTables_info" id="kt_datatable_fixed_header_info" role="status" aria-live="polite">Showing @(Model?.pagedListData?.FirstItemOnPage ?? 0) to @(Model?.pagedListData?.LastItemOnPage ?? 0) of @(Model?.pagedListData?.TotalItemCount ?? 0) records</div>
    </div><div class="col-sm-12 col-md-7 d-flex align-items-center justify-content-center justify-content-md-end">
        <div class="dataTables_paginate paging_simple_numbers" id="kt_datatable_fixed_header_paginate">
            @if (Model.hasPagination)
            {
                <div>
                    @Html.PagedListPager((IPagedList)Model.pagedListData, page => Url.Page("Index", "PagedList",
                    new
                    {
                        pn = page,
                        ps = Model.pageSize,
                        so = Model.sortOrder,
                        sc = Model.sortColumn,
                        nm = Model.globalSearch
                    }),
                                PagedListRenderOptions.EnableUnobtrusiveAjaxReplacing(new PagedListRenderOptions()
                                {
                                    PageClasses = new string[] { "page-link" },
                                    LiElementClasses = new string[] { "page-item" },
                                    UlElementClasses = new string[] { "pagination pagination-circle pagination-outline" },
                                    EllipsesElementClass = "ki-duotone ki-double-left fs-2",
                                    Display = PagedListDisplayMode.IfNeeded,
                                    DisplayLinkToFirstPage = PagedListDisplayMode.Always,
                                    DisplayLinkToLastPage = PagedListDisplayMode.Always,
                                    DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
                                    DisplayLinkToNextPage = PagedListDisplayMode.Always,
                                    LinkToPreviousPageFormat = "<i class='fas fa-angle-left'></i>",
                                    LinkToNextPageFormat = "<i class='fas fa-angle-right'></i>",
                                    LinkToFirstPageFormat = "<i class='fas fa-step-backward'></i>",
                                    LinkToLastPageFormat = "<i class='fas fa-step-forward'></i>",
                                    MaximumPageNumbersToDisplay = 10, // Adjust this number as needed
                                }, new AjaxOptions()
                                { HttpMethod = "Get", UpdateTargetId = "_postList", OnBegin = "showInTableLoader()", OnSuccess = "", OnComplete = "hideInTableLoader()" }))
            </div>
                        }
        </div>
    </div>
</div>


<div id="tableLoader" class="loader-container">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>


<script src="~/js/ktable.js" asp-append-version="true"></script>
<script type="text/javascript">

    $(function () {
        KTMenu.init()

         $(document).ready(function () {
            $("#tableLoader").removeClass("hidden"); // Show loader on page load

            $(document).ready(function () {
                $("#tableLoader").addClass("hidden");
            });
        });

        $('.btnItemEdit').click(function () {
            debugger
            var modID = $(this).attr('keyID')
            var url = $("#hidManagePageUrl").val() + "?id=" + modID + "&mode=edit"
            top.showPopup("Update Offer", url, 600, 420, window.frameElement.id);
            return false;
        });

        $('.btnResolveItem').click(function () {
            var keyID = $(this).attr('keyID');
            Swal.fire({
                title: 'Resolve Issue',
                input: 'textarea',
                inputPlaceholder: 'Enter your comments here...',
                inputAttributes: {
                    'aria-label': 'Type your comment here'
                },
                showCancelButton: true,
                confirmButtonText: 'Resolve',
                cancelButtonText: 'Cancel',
                customClass: {
                    confirmButton: 'btn btn-primary',
                    cancelButton: 'btn btn-secondary'
                },
                preConfirm: (comment) => {
                    if (!comment) {
                        Swal.showValidationMessage('Comment is required.');
                    }
                    return comment;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    var data = {
                        Id: keyID,  // Changed from keyid
                        Comment: result.value,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    };
                    // Make sure URL includes handler parameter
                var url = $("#hidDeletePageUrl").val();
                            console.log("URL:", url);
                            console.log("Data:", data);
                postAjaxResolveIssuerData(url, data, function (e) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Resolved!',
                            text: 'The issue has been resolved.',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        $("#btnRefresh").trigger("click");
                    });
                }
            });
            return false;
        });

        function postAjaxResolveIssuerData(url, data, callback) {
            console.log("url:", url);
            $.ajax({
                type: "POST",
                url: url,
                data: $.param(data),
                success: function (response) {
                    if (response.success) {
                        callback(response);
                    } else {
                        Swal.fire('Error', response.message, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error details:", xhr.responseText); // Add debugging
                    Swal.fire('Error', 'An unexpected error occurred.', 'error');
                }
            });
        }
    });

</script>